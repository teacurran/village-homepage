<!-- anchor: project-plan-title -->
# Project Plan: Village Homepage

**Version:** 1.0  
**Date:** 2026-01-08  
**Generated By:** Codex GPT-5 ProjectPlanner

<!-- anchor: project-overview -->
## 1. Project Overview

- **Goal:** Deliver a compliant, customizable Java 21 + Quarkus homepage platform that unifies personalized widgets, classifieds, curated directories, public profiles, and AI-assisted analytics for VillageCompute.
- **High-Level Requirements Summary:**
  - Personalized widget grid (news, weather, stocks, social, quick links, RSS, search) with anonymous-to-authenticated merge (Policy P1) and drag-and-drop persistence via JSONB layouts.
  - Marketplace with PostGIS geo search (Policies P6, P11), Stripe-powered posting fees/refunds (Policy P3), rate limiting, delayed job lifecycle, and masked communication.
  - Good Sites directory with screenshot retention (Policy P4), karma-based moderation, screenshot service, AI categorization (Policies P2, P10), and bubbling logic.
  - Public profile templates (public_homepage, your_times, your_report) with curated feed items, SEO metadata (F11.9), screenshot integration, and consent-aware sharing.
  - Background jobs for feeds, AI tagging, social refresh, screenshot capture, click stats rollups, and compliance exports using delayed job queues (DEFAULT/HIGH/LOW/BULK/SCREENSHOT per P12).
  - Feature flags with cohort hashing and analytics consent controls (Policies P7, P14), plus Ops analytics dashboards for click tracking and AI budgets.
  - Infrastructure alignment with k3s, Cloudflare R2, Elasticsearch, Mailpit dev stack, composer-type TypeScript builds (Policy P8), and CI/CD gating on Sonar + coverage.
- **Key Assumptions:**
  - Meta Graph API is the only social provider for v1; adapters should be pluggable for future networks but remain disabled via flags.
  - Infrastructure repo (`../villagecompute`) controls Kubernetes manifests, so this plan focuses on in-repo assets, configs, and docs.
  - All non-functional targets (latency, budget, retention) are baseline; product can stretch them later via ADRs.
  - Developers have access to sibling repos (`village-storefront`, `village-calendar`) to copy auth/rbac and job patterns rather than duplicating logic here.
  - Multi-region expansion and internationalization are future work; current directory + marketplace scope remains US/Canada.

<!-- anchor: core-architecture -->
## 2. Core Architecture

- **Architectural Style:** Modular layered monolith on Quarkus 3.26.x with Panache ActiveRecord, delayed job orchestration, and ExperienceShell delivering Qute-rendered pages enhanced by React islands.
- **Technology Stack:**
  - Frontend: Qute templates + TypeScript React 18 islands, gridstack.js, Ant Design (antd, @antv g2plot/s2/l7), esbuild bundling driven by `frontend-maven-plugin`.
  - Backend: Java 21, Quarkus, RESTEasy Reactive, Panache ORM, LangChain4j (Claude Sonnet 4), Quarkus Scheduler, SmallRye Metrics, OpenTelemetry.
  - Database: PostgreSQL 17 with PostGIS, JSONB heavy schemas, pg_partman for partitioning (`link_clicks`, `feature_flag_evaluations`).
  - Messaging/Queues: Database-backed delayed jobs referencing `village-calendar` pattern with DEFAULT/HIGH/LOW/BULK/SCREENSHOT queues and per-handler concurrency controls.
  - Deployment: Maven + Jib containers deployed to VillageCompute k3s; docker-compose for local Postgres/PostGIS, Elasticsearch, Mailpit, MinIO, Jaeger.
  - Other Libraries/Tools: Stripe SDK, Alpha Vantage client, Open-Meteo/NWS clients, jvppeteer, FeatureFlagService, RateLimitService (Caffeine), StorageGateway for Cloudflare R2.
- **Key Components/Services:**
  - ExperienceShell/Qute Layouts orchestrating widgets, SEO, and React mount points (component diagram refined in I1).
  - AuthIdentityService handling OAuth bootstrap, consent flows, anonymous merges, audit tables.
  - UserPreferenceService managing JSONB layouts, topics, watchlists, weather locations, theme tokens.
  - FeedAggregationService + AiTaggingService for RSS ingestion, dedupe, LangChain4j tagging, AiUsageTracking compliance.
  - WeatherService (Open-Meteo + NWS) and StockService (Alpha Vantage) with caching, scheduling, failover.
  - SocialIntegrationService managing Meta tokens, staleness banners, Policy P13 fallbacks.
  - MarketplaceService covering categories, listings, PostGIS search, Stripe flows, promotions, notifications, fraud heuristics.
  - DirectoryService powering Good Sites hierarchy, submissions, voting, screenshot capture, AI categorization, bubbling logic.
  - ProfileService delivering templates, curated articles, screenshot references, SEO metadata.
  - ClickTrackingService ingesting `/track/click`, rollups, analytics DTOs.
  - StorageGateway abstracting Cloudflare R2 buckets with WebP conversions + signed URLs.
  - FeatureFlagService & RateLimitService providing gating, analytics logging, violation tracking.
  - OpsAnalyticsPortal summarizing job depth, AI budgets, click stats, rate limit breaches.
- **Data Model Overview:**
  - Users table with `is_anonymous`, `preferences`, `directory_karma`, `analytics_consent`; audit tables for merges, feature flags, payments.
  - RSS + feed_items with JSONB ai_tags, user subscriptions, delayed job references.
  - marketplace_* tables for categories, listings, promotions, images, messages, saved searches, plus PostGIS `location` fields.
  - directory_* tables for categories, sites, votes, moderators, flags, screenshot versions, karma metrics.
  - Profile tables (user_profiles, profile_curated_articles, reserved_usernames) storing template configs and curated mapping.
  - Supporting tables: ai_usage_tracking, weather_cache, stock_quotes, social_tokens/posts, delayed_jobs, link_clicks partitions, click_stats rollups, rate_limit_config/violations, inbound_emails.
  - Data structure diagrams (component + ERD) scheduled in I1.
- **API Contract Style:** RESTful JSON endpoints documented via OpenAPI v3; `/api` for authenticated users, `/admin/api` for privileged flows, `/track/click` for redirects. Initial OpenAPI spec drafted in I1 then expanded during feature iterations (I2-I5). DTOs live under `api/types` and follow snake_case serialization.
- **Communication Patterns:**
  - Synchronous REST between Qute/React layers and domain services; FeatureFlagService invoked per request to ensure deterministic cohorts.
  - Asynchronous delayed jobs for feed ingestion, AI tagging, screenshot capture, queue rollups, exports, cleanup; JobOrchestrator handles scheduling/backoff and telemetry.
  - Storage interactions via signed URLs to Cloudflare R2; Stripe + Meta Graph + Alpha Vantage via HTTP with retry/circuit breaker wrappers.
  - Observability uses OpenTelemetry contexts propagated through HTTP + job payload metadata.

<!-- anchor: key-architectural-artifacts -->
## 2.1. Key Architectural Artifacts Planned

- Component Diagram (Mermaid) – Visualize primary Quarkus modules, shared utilities, and external systems (Created in I1.T3, stored at `docs/diagrams/component_overview.mmd`).
- Container & Deployment Diagram set (PlantUML) – Show pod types, worker queues, k3s interactions, storage services (Created in I1.T4).
- Data Model ERD (PlantUML) – Capture major tables/entities, relationships, retention notes (Created in I1.T5, refined in I3.T2 for marketplace add-ons).
- OpenAPI Specification v1 (YAML) – Seed spec for authentication, widgets, marketplace endpoints (Created in I2.T2, updated in I3.T3, I4.T3).
- Feature Flag & Rate Limit Playbook (Markdown) – Document evaluation logic, analytics, governance flows (Created in I2.T4).
- Job Orchestration Blueprint (Markdown) – Queue matrix, handler contracts, failure policies (Created in I1.T6).
- Directory Architecture Addendum (Mermaid + Markdown) – Detail Good Sites bubbling, screenshot flows, karma transitions (Created in I4.T2).
- Profile Template Interaction Flow (Mermaid Sequence) – Map curated article assignment and publishing pipeline (Created in I4.T4).
- Ops Analytics Dashboard Specification (Markdown + wireframes) – Chart definitions, API mapping, KPI descriptions (Created in I5.T2).
- Compliance & Data Export Runbook (Markdown) – Enumerate GDPR/CCPA steps, retention, purge verification (Created in I5.T4).

<!-- anchor: directory-structure -->
## 3. Directory Structure

```
village-homepage/
├── .codemachine/
│   └── artifacts/
│       └── plan/                 # Generated planning artifacts (this deliverable)
├── docs/
│   ├── architecture/
│   │   ├── component_overview.mmd
│   │   ├── deployment_views.puml
│   │   ├── data_model.puml
│   │   └── job_orchestration.md
│   ├── ui-guides/
│   │   ├── widget_matrix.md
│   │   ├── marketplace_playbook.md
│   │   ├── good_sites_playbook.md
│   │   └── profile_templates.md
│   ├── ops/
│   │   ├── compliance_runbook.md
│   │   ├── ai_budget_monitoring.md
│   │   └── queue_health_checklist.md
│   └── adr/                      # Architectural Decision Records per major deviation
├── api/
│   └── openapi.yaml              # Spec-first contracts kept in sync per iteration plan
├── src/
│   ├── main/
│   │   ├── java/villagecompute/homepage/
│   │   │   ├── api/
│   │   │   │   ├── rest/         # REST resources for widgets, marketplace, directory, profiles, admin
│   │   │   │   └── types/        # DTO records shared with frontend/React islands
│   │   │   ├── config/
│   │   │   ├── data/models/      # Panache entities (users, listings, feeds, directories, etc.)
│   │   │   ├── integration/      # External API clients (Alpha Vantage, Meta, Open-Meteo, Stripe)
│   │   │   ├── jobs/             # Delayed job handlers + scheduler enqueuers
│   │   │   ├── services/         # Domain logic modules described in Section 2
│   │   │   └── util/             # Shared utilities (StorageGateway, FeatureFlagService, RateLimitService)
│   │   └── resources/
│   │       ├── META-INF/resources/
│   │       │   ├── templates/    # Qute layouts for homepage, marketplace, directory, profiles, admin, email
│   │       │   ├── assets/
│   │       │   │   ├── ts/       # TypeScript React islands (widgets, admin dashboards, profile editors)
│   │       │   │   └── js/       # Built bundles from esbuild
│   │       │   └── data/         # Static JSON (category hierarchies, reserved usernames)
│   │       └── application.properties  # Environment-specific config with P* policy knobs
│   └── test/                     # Quarkus + Playwright tests, Testcontainers setups
├── migrations/
│   └── src/main/resources/db/migration/  # MyBatis migrations, policy tables, indexes
├── scripts/                      # Dev/ops helper scripts (seed data, queue monitors, lint hooks)
├── package.json + tsconfig.json  # Frontend build definitions (esbuild, TypeScript)
├── pom.xml                       # Maven build descriptor with frontend plugin, Jib, LangChain4j, etc.
├── docker-compose.yml            # Local Postgres/PostGIS, Elasticsearch, Mailpit, MinIO, Jaeger stack
├── README.md                     # Developer onboarding referencing docs and plan anchors
└── CODEOWNERS                    # Ownership map by package/domain
```

<!-- anchor: directives-and-process -->
## 4. DIRECTIVES & STRICT PROCESS

1. **Policy Alignment:** Every deliverable must cite relevant Policy IDs (P1-P14) inside ADRs, job handlers, and UI docs to keep compliance explicit; deviations require sign-off from Foundation Architect.
2. **Spec-First Delivery:** OpenAPI, diagram, and UI playbooks must precede implementation; downstream agents treat these artifacts as contracts and update them during each iteration task.
3. **Feature Flag Governance:** All net-new widgets, marketplace promotions, Good Sites modules, and AI-driven experiments launch behind FeatureFlagService toggles with analytics consent hooks and 90-day evaluation retention.
4. **Job Discipline:** Delayed jobs must declare queue, concurrency, retry policy, telemetry fields, and idempotency identifiers before merging; JobOrchestrator documentation is part of iteration acceptance.
5. **Rate Limiting & Observability:** RateLimitService quotas apply to every REST write action; instrumentation (metrics, logs, traces) is mandatory for widgets, queue handlers, and payment flows to uphold SLO observability.
6. **Compliance Workflow:** GDPR consent flows, export/deletion jobs, audit tables, and screenshot retention policies must be implemented exactly as described; no shortcuts or data merges without recorded consent and purge schedule.
7. **Parallel Work Enablement:** Artifacts (diagrams, specs, playbooks) must unblock autonomous agents per iteration; tasks explicitly declare inputs/outputs to avoid cross-team contention and allow concurrent execution.
