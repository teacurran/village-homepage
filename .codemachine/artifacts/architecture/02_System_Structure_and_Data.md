<!-- anchor: system-architecture-blueprint -->
# System Architecture Blueprint: Village Homepage

**Version:** 1.0
**Date:** 2026-01-08
**Generated By:** Structural_Data_Architect

<!-- anchor: 1-introduction-goals -->
## 1. Introduction & Goals

*   **1.1. Project Vision:** Village Homepage unifies personalized content, commerce-style classifieds, curated directories, and public storytelling into a single Quarkus-powered SaaS so residents and visitors of the VillageCompute ecosystem can compose their own information hub with compliant data handling.
    It adheres to the Large-scale directive in the foundation by prioritizing modular domain ownership, policy-driven governance, and extensibility for future regions and feed types without rewriting the entire platform.

*   **1.2. Key Objectives:** The architecture must deliver user experiences spanning anonymous previews, authenticated personalization, admin oversight, and partner integrations while sustaining policy mandates P1-P14.
    - Provide drag-and-drop homepage widgets with persistent JSONB layouts that synchronize between anonymous and authenticated states, ensuring Policy P1 merge guarantees remain auditable.
    - Aggregate news, weather, stocks, social posts, marketplace listings, and Good Sites entries through isolated services that share the same Quarkus runtime yet avoid direct entity coupling.
    - Enforce AI tagging and fraud detection coverage via LangChain4j pipelines while observing the $500/month ceiling through shared AiTaggingBudgetService instrumentation.
    - Maintain policy-driven retention (indefinite screenshots, 90-day evaluation logs, 30-day anonymous cleanup) with scheduled jobs that keep storage footprints predictable.
    - Support SEO-forward public profiles (`/u/{username}`) and browseable directories so curated content and marketplace inventory surface through trackable links.
    - Ensure admins can govern feature flags, feeds, rate limits, AI budgets, and queue workloads through OpsAnalyticsPortal surfaces that rely solely on DTOs and rollups.
    - Guarantee TypeScript build integration (frontend-maven-plugin) so `./mvnw package` always emits synchronized assets for Qute templates and Ant Design React islands.
    - Provide portable data export/deletion flows for GDPR/CCPA requests with delayed-job orchestration that emits Cloudflare R2 bundles referenced by audit logs.

*   **1.3. Scope:** This blueprint addresses the structural layout of the Java 21 + Quarkus monolith, the delineation of domain packages, the external boundary of integrations (OIDC, Alpha Vantage, Open-Meteo, NWS, Meta Graph API, Stripe, Cloudflare R2, Elasticsearch), the shared delayed job queues, and the persistent stores (PostgreSQL 17 with PostGIS partitions plus Elasticsearch indices).
    Operational tuning, runtime scaling, and workflow choreography are deferred to other roles; here we define the static placement of services, DTO contracts, and primary data schemas enumerated in the foundation.

*   **1.4. Key Assumptions:** The architecture relies on assumptions listed in Section 6 of the foundation—Meta is the only social provider in v1, screenshot pools are fixed-size per pod, Stripe events follow standard payment_intent semantics, markdown is sanitized server-side, and feature flag analytics stay decoupled from click stats once consent is revoked.
    Additional structural assumptions: Elasticsearch outages trigger Postgres fallback queries without schema changes, object storage prefixes remain stable for retention scripting, and AI categorization is invoked only through the shared AiTaggingService contract.

<!-- anchor: 2-architectural-drivers -->
## 2. Architectural Drivers

*   **2.1. Functional Requirements Summary:** The system must authenticate users via Google/Facebook/Apple OIDC, issue secure `vu_anon_id` cookies, merge anonymous layouts into authenticated accounts with logged consent, manage widget grids (news/weather/stocks/social/quick links/search), power specialized domains (marketplace listings with payments and PostGIS radius search, Good Sites directory with voting and screenshots, public profile templates, admin analytics dashboards), log click-throughs, and expose background jobs for feeds, AI tagging, screenshots, link health, and rate-limit enforcement.
    It must also orchestrate delayed jobs for screenshot capture (SCREENSHOT queue with Puppeteer pools), AI tagging (BULK), listing image processing (BULK), social refresh (LOW), and analytics rollups (DEFAULT), ensuring each handler remains idempotent and versioned.

*   **2.2. Non-Functional Requirements (NFRs):**
    - **Performance:** Widget layout queries and directory browsing must remain <100ms p95 through Panache caching and PostGIS indexes; marketplace radius search targets <200ms p99 for 250-mile queries per Policy P11.
    - **Scalability:** Horizontal scalability is achieved by segregating API pods from queue-focused pods, by using feature flags (P7) to meter launch exposure, and by storing screenshots/media on Cloudflare R2/CDN to keep pods stateless.
    - **Reliability:** Job backlog telemetry, AI budget watchdogs, and screenshot pool semaphores enforce graceful degradation (e.g., queueing AI tagging post 90% spend) instead of hard failures.
    - **Security & Compliance:** OAuth tokens, Stripe secrets, and social refresh tokens stay encrypted; analytics consent is honored via selective logging, and GDPR deletion triggers immediate purge of feature_flag_evaluations, social tokens, and click rows referencing the user.
    - **Observability:** Structured logging with trace IDs, SmallRye Metrics instrumentation for job queue depth, and Jaeger tracing for feed/AI/screenshot flows provide the data necessary for Ops runbooks.
    - **Maintainability:** Modular package layout (api, data.models, services, integration, jobs) with Panache ActiveRecord patterns enforces consistent data access and reduces repository surface area for each squad.
    - **Testability:** Testcontainers-backed Quarkus tests target Postgres/PostGIS and Elasticsearch, while DTO validators and TypeScript typechecking maintain 80%+ coverage and Sonar quality gates.

*   **2.3. Constraints & Preferences:**
    - **Foundation Mandates:** Architectural style, stack, delayed job pattern, Panache ActiveRecord, Quarkus 3.26.x, PostgreSQL 17 + PostGIS, Elasticsearch 8, Cloudflare R2, LangChain4j, jvppeteer, and feature flag governance all stem from the foundation and may not change without ADRs.
    - **Build & Deployment:** Single Maven lifecycle invoking `frontend-maven-plugin` ensures TypeScript assets accompany every Quarkus build; containers must be produced via Jib and deployed to VillageCompute-managed k3s clusters.
    - **Policy Compliance:** Data merges (P1), AI budget throttling (P2/P10), payment refunds/fraud (P3), screenshot retention (P4), token refresh/retention (P5), PostGIS-only geo search (P6/P11), feature flag logging/privacy (P7/P14), TypeScript workflow (P8), anonymous user storage strategy (P9), screenshot capture pooling (P12), social UX fallback (P13), and click tracking retention (F14.9) constrain structural choices.
    - **No SPA:** Frontend must remain Qute-first with targeted React islands; no SPA frameworks beyond React mounts described in the stack are permitted.
    - **No External Message Brokers:** All async processing must continue to use the delayed_jobs table/handlers with queue segregation instead of introducing Kafka/SQS/etc.
    - **Data Retention Windows:** Raw click logs (90 days), feature flag evaluations (90 days), anonymous accounts (30 days), screenshot versions (indefinite), social archives (indefinite), and audit records (90-day retention for merge logs) determine partitioning and cleanup job cadence.

<!-- anchor: 3-proposed-architecture -->
## 3. Proposed Architecture (Structural View)

*   **3.1. Architectural Style:** Modular layered monolith on Quarkus 3.26.x that segments API resources, services, integrations, models, and jobs into explicit packages while sharing the same executable and configuration profile; asynchronous boundaries rely on delayed job queues, and external integrations are abstracted through dedicated adapters so squads can iterate independently without microservice overhead.

*   **3.2. Technology Stack Summary:**
    | Layer | Technology Decisions | Notes |
    |-------|----------------------|-------|
    | Backend Runtime | Java 21 LTS on Quarkus 3.26.x | Aligns with foundation 'Standard Kit'; enables live reload for dev and native compilation for ops. |
    | Application Framework | Panache ActiveRecord, RESTEasy Reactive, Qute, Config, Scheduler | Provides uniform entity access, templating, and scheduling for jobs. |
    | Database | PostgreSQL 17 with PostGIS + JSONB | Stores core tables, analytics partitions, and spatial indexes for marketplace search. |
    | Search Engine | Hibernate Search ORM + Elasticsearch 8 cluster | Powers marketplace and directory queries with fallback to Postgres. |
    | Frontend | Qute templates, TypeScript + React 18 islands, gridstack.js, Ant Design ecosystem (@antv g2plot/s2/l7/g6) | Delivers server-rendered pages enriched with React mounts controlled via mounts.ts. |
    | Build Tooling | Maven + frontend-maven-plugin + esbuild + npm ci | Guarantees a single build command compiles TS assets alongside Java artifacts. |
    | Object Storage | Cloudflare R2 (S3-compatible) behind CDN | Persists listing media, profile assets, screenshots, exports with signed URLs and WebP conversions. |
    | AI & Automation | LangChain4j with Claude Sonnet 4, AiTaggingBudgetService, AI cost tracking tables | Batches tagging, categorization, and fraud analysis with budget enforcement and fallback behaviors. |
    | External Integrations | Alpha Vantage, Open-Meteo, National Weather Service, Meta Graph API, Stripe, Mailpit (dev), Jaeger | Provide market data, weather, social feeds, payments, and observability endpoints. |
    | Async Processing | Delayed job queues (DEFAULT/HIGH/LOW/BULK/SCREENSHOT) referencing village-calendar pattern | Supports feed refresh, AI tagging, image processing, queue-specific concurrency, and retention cleanups. |
    | Observability & Security | Structured logging, SmallRye Metrics, OpenTelemetry → Jaeger, Quarkus OIDC, Config-driven secrets | Enforces traceability, metrics-driven ops, and secure OAuth-based sessions. |

*   **3.3. System Context Diagram (C4 Level 1):**
    *   **Description:** The context view frames Village Homepage as the central system that serves anonymous visitors, authenticated members, administrators, and background integrations while exchanging data with financial, AI, storage, weather, stock, social, and observability platforms.
        Critical policies appear as annotations so stakeholders understand why certain flows (e.g., AI tagging, screenshot retention, feature flags) exist at the boundary level.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
        LAYOUT_WITH_LEGEND()
        AddElementTag("Policy", $bgColor="#E5E5E5", $fontColor="#111111")
        AddRelTag("Policy", $textColor="#111111", $lineColor="#999999")
        Person(AnonUser, "Anonymous Visitor", "Receives secure vu_anon_id cookie, sees default widgets, interacts with gridstack layout")
        Person(User, "Authenticated Member", "Logs in via OAuth provider, customizes homepage, manages marketplace listings and profiles")
        Person(AdminUser, "Village Admin/Moderator", "Controls feature flags, feeds, rate limits, moderation queues, compliance exports")
        Person_Ext(OAuthProvider, "OIDC Providers", "Google, Facebook, Apple for login")
        System_Boundary(VH, "Village Homepage Platform") {
          System(VillageHomepageSystem, "Village Homepage", "Quarkus 3.26.x layered monolith delivering Qute pages, REST APIs, delayed jobs, and integrations")
        }
        System_Ext(AlphaVantage, "Alpha Vantage", "Stock quotes and sparkline data")
        System_Ext(OpenMeteo, "Open-Meteo", "Global hourly/daily weather forecasts")
        System_Ext(NWS, "National Weather Service", "U.S. alerts and official weather data")
        System_Ext(MetaGraph, "Meta Graph API", "Instagram & Facebook posts plus token refresh")
        System_Ext(Stripe, "Stripe Payments", "Posting fees, promotions, refunds per Policy P3")
        System_Ext(CloudflareR2, "Cloudflare R2", "S3-compatible storage for screenshots, listings, exports")
        System_Ext(ElasticsearchCluster, "Elasticsearch 8", "Search indices for marketplace and directory")
        System_Ext(PostgresDB, "PostgreSQL 17 + PostGIS", "Primary relational store with JSONB + GIS")
        System_Ext(LangChainClaude, "LangChain4j + Claude Sonnet", "AI tagging, categorization, fraud analysis with $500/month cap")
        System_Ext(Mailpit, "Mailpit/SMTP", "Dev email sink and outbound notifications")
        System_Ext(Jaeger, "Jaeger", "Tracing sink for jobs and REST flows")
        System_Ext(MinIODev, "MinIO (dev)", "Local S3 emulation for developer workflows")
        System_Ext(Dr5hnDataset, "dr5hn Geo Dataset", "Seed data for US/Canada cities with coordinates")
        System_Ext(FeatureFlagClients, "Feature Flag Consumers", "Downstream analytics tools reading exported cohorts")
        System_Ext(VillageCalendar, "Village Calendar Reference", "Source of delayed job implementation guidance")
        System_Ext(VillageStorefront, "Village Storefront Reference", "Source of role/permission standards")
        ' Policy P1 mandates merge audit logging for anonymous → authenticated transitions.
        ' Policy P2/P10 cap AI tagging spend at $500/month with staged throttles.
        ' Policy P4 demands indefinite screenshot retention with version history.
        ' Policy P7/P14 dictate feature flag cohorts with GDPR-aware logging.
        ' Policy P12 defines SCREENSHOT queue pool sizing per pod.
        ' Policy P13 ensures graceful archive mode for social tokens.
        Rel(AnonUser, VillageHomepageSystem, "Browses homepage, receives vu_anon_id cookie, interacts with default widgets (P9)", "HTTPS")
        Rel(User, VillageHomepageSystem, "Configures widgets, marketplace listings, Good Sites submissions, public profiles", "HTTPS")
        Rel(AdminUser, VillageHomepageSystem, "Uses admin dashboards for flags, feeds, analytics, moderation", "HTTPS + MFA")
        Rel(OAuthProvider, VillageHomepageSystem, "Delivers OIDC tokens for bootstrap/login", "OAuth2")
        Rel(VillageHomepageSystem, AlphaVantage, "Fetch stock quotes + sparkline data (F5)", "REST")
        Rel(VillageHomepageSystem, OpenMeteo, "Weather forecasts for international users (F4)", "REST")
        Rel(VillageHomepageSystem, NWS, "US weather alerts + grid forecasts (F4)", "REST")
        Rel(VillageHomepageSystem, MetaGraph, "Social posts + proactive token refresh (P5/P13)", "HTTPS")
        Rel(VillageHomepageSystem, Stripe, "Posting fees, promotions, refunds (P3/F12.8)", "HTTPS")
        Rel(VillageHomepageSystem, CloudflareR2, "Store screenshots, listing images, exports (P4)", "S3 API")
        Rel(VillageHomepageSystem, ElasticsearchCluster, "Index marketplace listings + directory sites (F12/F13)", "REST")
        Rel(VillageHomepageSystem, PostgresDB, "Transactional data, JSONB preferences, delayed jobs (F10)", "JDBC")
        Rel(VillageHomepageSystem, LangChainClaude, "AI tagging batches, fraud analysis, categorization suggestions (P2/P10)", "HTTPS")
        Rel(VillageHomepageSystem, Mailpit, "Dev/test emails for reminders, alerts, moderation updates", "SMTP")
        Rel(VillageHomepageSystem, Jaeger, "Trace exports for REST + job flows", "OTLP")
        Rel(VillageHomepageSystem, MinIODev, "Local storage for developer mode", "S3 API")
        Rel(Dr5hnDataset, VillageHomepageSystem, "Provides initial geo data for PostGIS seeding", "Data Import")
        Rel(VillageHomepageSystem, FeatureFlagClients, "Exports evaluation analytics (P7/P14)", "CSV/JSON")
        Rel(VillageHomepageSystem, VillageCalendar, "Reuses delayed job orchestration pattern", "Knowledge Reference")
        Rel(VillageHomepageSystem, VillageStorefront, "Reuses role and permission standards", "Knowledge Reference")
        Rel(AnonUser, OAuthProvider, "Initiates OAuth flows when converting to authenticated state", "Browser Redirect")
        Rel(User, Stripe, "Completes Stripe Checkout for posting fees/promotions", "HTTPS Redirect")
        Rel(User, CloudflareR2, "Downloads exports/screenshots via signed URLs", "HTTPS")
        Rel(User, MetaGraph, "Completes reconnection flow when tokens expire", "Browser Redirect")
        Rel(AdminUser, PostgresDB, "Executes SQL exports/audits through admin tooling", "Read-only JDBC")
        Rel(AdminUser, Jaeger, "Views distributed traces for incident response", "HTTPS")
        Rel(AdminUser, Mailpit, "Validates email templates within dev environment", "Web UI")
        Rel(AnonUser, FeatureFlagClients, "Assigned session-based cohorts for rollouts (P7)", "Session Hash")
        Rel(User, FeatureFlagClients, "Participates in cohort experiments", "Hashed user ID")
        Rel(VillageHomepageSystem, Mailpit, "Receives inbound replies via IMAP polling (F14.3)", "IMAP")
        BiRel(VillageHomepageSystem, Stripe, "Webhook events for payments, refunds, disputes", "HTTPS")
        Rel(VillageHomepageSystem, AdminUser, "Sends alerts (AI budget, queue backlog) via email", "SMTP")
        Rel(VillageHomepageSystem, User, "Serves public profile pages and curated Good Sites listing", "HTTPS + Click Tracking")
        Rel(User, PostgresDB, "CRUD operations via services for listings, preferences, submissions", "Panache/JDBC")
        Rel(User, ElasticsearchCluster, "Search results for marketplace/directory flows", "Backend-mediated")
        Rel(User, LangChainClaude, "Indirect AI tagging processing for curated content", "Async")
        Rel(AdminUser, LangChainClaude, "Reviews AI usage metrics through budget monitoring UI", "Report")
        Rel(VillageHomepageSystem, MinIODev, "Uses dev bucket for local testing of storage flows", "S3 API")
        Rel(AdminUser, Stripe, "Reviews dashboard for disputes", "Stripe Dashboard")
        Rel(User, CloudflareR2, "Uploads listing images via signed PUT URLs", "HTTPS")
        Rel(User, CloudflareR2, "Downloads screenshot versions via CDN", "HTTPS")
        Rel(AdminUser, MetaGraph, "Views health of social integrations in ops UI", "Indirect")
        Rel(User, VillageHomepageSystem, "Submits votes for Good Sites categories", "HTTPS + Rate limiting")
        Rel(User, VillageHomepageSystem, "Participates in marketplace posting and contact flows with email masking", "HTTPS + Email Relay")
        Rel(AdminUser, Mailpit, "Validates inbound email parsing logic", "Dev UI")
        Rel(User, Mailpit, "Receives dev-mode copies of transactional emails", "SMTP")
        Rel(AdminUser, FeatureFlagClients, "Downloads analytics/flag exports", "CSV")
        Rel(VillageHomepageSystem, FeatureFlagClients, "Feeds evaluation logs for analysis", "Batch Export")
        Rel(User, AlphaVantage, "Receives stock data via backend service", "Indirect")
        Rel(User, OpenMeteo, "Receives weather data via backend service", "Indirect")
        Rel(User, NWS, "Receives US weather alerts via backend service", "Indirect")
        Rel(AdminUser, VillageHomepageSystem, "Uses OpsAnalyticsPortal to view metrics", "HTTPS")
        Rel(VillageHomepageSystem, LangChainClaude, "AI categorization for Good Sites imports", "HTTPS")
        Rel(VillageHomepageSystem, LangChainClaude, "Fraud heuristics for marketplace (P3)", "HTTPS")
        Lay_D(AnonUser, User)
        Lay_D(User, AdminUser)
        Lay_R(VillageHomepageSystem, PostgresDB)
        Lay_R(VillageHomepageSystem, ElasticsearchCluster)
        Lay_R(VillageHomepageSystem, CloudflareR2)
        Lay_R(VillageHomepageSystem, Stripe)
        Lay_R(VillageHomepageSystem, MetaGraph)
        Lay_D(AlphaVantage, LangChainClaude)
        Lay_D(OpenMeteo, NWS)
        Lay_D(Stripe, CloudflareR2)
        Lay_D(VillageCalendar, VillageStorefront)
        Lay_D(MinIODev, CloudflareR2)
        @enduml
        ~~~

*   **3.4. Container Diagram (C4 Level 2):**
    *   **Description:** The container view decomposes the platform into the Quarkus Modular Monolith (serving Qute HTML, REST APIs, and queue runners), worker pods tuned per queue policy, PostgreSQL/PostGIS, Elasticsearch, Cloudflare R2 storage, external providers, and supporting observability nodes.
        Each container explicitly notes key technologies and policy ties so squads understand where to extend functionality without breaching architectural seams.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
        LAYOUT_WITH_LEGEND()
        ' Delayed job queues map to pods via env vars so SCREENSHOT workloads can be isolated.
        ' FeatureFlagEngine logs evaluations only when consent is granted (P14).
        ' StorageGateway enforces WebP conversion and thumbnail generation per P4.
        Container(QuarkusApp, "Quarkus Modular Monolith", "Java 21 + Quarkus 3.26.x", "Serves Qute pages, REST APIs, Graph integrations, uses Panache models and FeatureFlagService")
        Container(WebFrontend, "Server-rendered Qute Templates + React Islands", "HTML + TypeScript", "Delivers experiences via DTOs and targeted React mounts")
        Container(JobWorkers, "Delayed Job Workers", "Quarkus queue pods", "Processes feeds, AI tagging, screenshots, listings, analytics, cleanup")
        ContainerDb(PostgreSQL, "PostgreSQL 17 + PostGIS", "SQL + JSONB + GIS", "Primary data store, delayed_jobs queue, audit trails, policy tables")
        ContainerDb(Elasticsearch, "Elasticsearch 8 Cluster", "HTTP + JSON", "Hibernate Search indices for marketplace + directory")
        Container(StorageGateway, "StorageGateway Service", "Java 21", "Wraps S3 client for Cloudflare R2, enforces WebP conversion, signed URLs")
        Container(ClickTrackingService, "Click Tracking + Redirect Service", "REST endpoint /track/click", "Logs raw clicks, queues rollups, enforces retention")
        Container(AdminAPIs, "Admin/Analytics REST APIs", "RESTEasy", "Feeds dashboards with DTOs for AntV charts")
        Container(FeatureFlagEngine, "Feature Flag Engine", "Quarkus bean", "Stable cohorts, logging, GDPR purge")
        Container(AuthIdentity, "AuthIdentity & Preference APIs", "REST/Panache", "Handles bootstrap, OAuth merge, preference storage")
        Container(ScreenshotPool, "Screenshot Pool", "jvppeteer", "Manages Chromium browser instances per P12")
        Person(Users, "End Users", "Anonymous and authenticated members across homepage, marketplace, directory, and profiles", "")
        Person(Admins, "Administrators & Moderators", "Super admins, ops, support, read-only roles", "")
        System_Ext(OIDC, "Google/Facebook/Apple OIDC", "OAuth providers")
        System_Ext(AlphaVantageAPI, "Alpha Vantage", "Stock data")
        System_Ext(OpenMeteoAPI, "Open-Meteo", "Weather data")
        System_Ext(NWSAPI, "National Weather Service", "US alerts")
        System_Ext(MetaGraphAPI, "Meta Graph API", "Social integrations")
        System_Ext(StripeAPI, "Stripe", "Posting fees, promotions, refunds")
        System_Ext(CloudflareR2Store, "Cloudflare R2", "Screenshots, listing media, exports")
        System_Ext(MailpitSMTP, "Mailpit/SMTP", "Outbound/inbound dev email")
        System_Ext(JaegerTrace, "Jaeger", "Trace storage")
        System_Ext(LangChainService, "LangChain4j Claude", "AI tagging + categorization")
        System_Ext(OpsTooling, "Village Ops Tooling", "Monitoring dashboards")
        Rel(OIDC, AuthIdentity, "OIDC tokens for authentication (F1)", "OAuth2")
        Rel(Users, WebFrontend, "Loads HTML + React mounts, submits forms, drags widgets", "HTTPS")
        Rel(WebFrontend, Users, "Sends interactive experiences", "HTTPS")
        Rel(QuarkusApp, WebFrontend, "Injects DTOs into Qute templates + React props", "Server rendering")
        Rel(WebFrontend, StorageGateway, "Requests signed upload/download URLs", "HTTPS")
        Rel(WebFrontend, ClickTrackingService, "Routes outbound links through /track/click", "HTTP redirect")
        Rel(QuarkusApp, PostgreSQL, "Reads/writes users, preferences, feeds, listings, profiles, jobs", "Panache/JDBC")
        Rel(QuarkusApp, Elasticsearch, "Indexes and queries textual data via Hibernate Search", "REST")
        Rel(QuarkusApp, StorageGateway, "Requests signed URLs and WebP transformations", "Quarkus bean call")
        Rel(StorageGateway, CloudflareR2Store, "Uploads/downloads media using S3 API", "HTTPS")
        Rel(ClickTrackingService, PostgreSQL, "Writes partitioned click logs + summary tables", "JDBC")
        Rel(ClickTrackingService, JobWorkers, "Queues rollup jobs for hourly aggregation", "Delayed Job payloads")
        Rel(JobWorkers, PostgreSQL, "Consume delayed_jobs, update domain tables, write audit logs", "JDBC")
        Rel(JobWorkers, StorageGateway, "Process screenshot/image payloads via signed URLs", "S3 API")
        Rel(JobWorkers, LangChainService, "Submit AI tagging/categorization batches via AiTaggingService", "HTTPS")
        Rel(JobWorkers, MetaGraphAPI, "Refresh social tokens, fetch posts per P5", "HTTPS")
        Rel(JobWorkers, OpenMeteoAPI, "Fetch scheduled weather data", "HTTPS")
        Rel(JobWorkers, NWSAPI, "Fetch alerts for US locations", "HTTPS")
        Rel(JobWorkers, AlphaVantageAPI, "Fetch quotes respecting rate limits", "HTTPS")
        Rel(JobWorkers, StripeAPI, "Handle webhook retries, refunds, promotions", "HTTPS")
        Rel(JobWorkers, MailpitSMTP, "Send scheduled reminders + inbound poller", "SMTP/IMAP")
        Rel(JobWorkers, JaegerTrace, "Push spans for async flows", "OTLP")
        Rel(QuarkusApp, AlphaVantageAPI, "Fetch ad-hoc watchlist refresh (F5)", "HTTPS")
        Rel(QuarkusApp, OpenMeteoAPI, "Fetch on-demand forecasts when user adds location", "HTTPS")
        Rel(QuarkusApp, NWSAPI, "Retrieve US-specific data for alerts", "HTTPS")
        Rel(QuarkusApp, MetaGraphAPI, "Initiate OAuth + fetch immediate social content", "HTTPS")
        Rel(QuarkusApp, StripeAPI, "Create checkout sessions for paid categories/promotions", "HTTPS")
        Rel(QuarkusApp, LangChainService, "Request AI suggestions for Good Sites + news tagging", "HTTPS")
        Rel(AdminAPIs, WebFrontend, "Feeds Ant Design dashboards with JSON data", "HTTPS")
        Rel(AdminAPIs, Admins, "Accessible only to admins with roles", "HTTPS")
        Rel(FeatureFlagEngine, QuarkusApp, "Injects gating decisions for controllers + DTO creation", "In-memory call")
        Rel(FeatureFlagEngine, PostgreSQL, "Reads flag definitions, writes evaluations + audits", "JDBC")
        Rel(FeatureFlagEngine, ClickTrackingService, "Shares session hashes for analytics correlation", "Internal event")
        Rel(AuthIdentity, PostgreSQL, "Reads user rows, writes merge audits, preferences, anonymous cleanup", "JDBC")
        Rel(AuthIdentity, JobWorkers, "Schedules merge/export/deletion jobs", "Delayed Job")
        Rel(AdminAPIs, FeatureFlagEngine, "Admins adjust flags + rollouts via UI", "HTTPS")
        Rel(AdminAPIs, JobWorkers, "Trigger manual replays or pause queues", "Command jobs")
        Rel(AdminAPIs, LangChainService, "View AI cost usage + override budget", "HTTPS")
        Rel(AdminAPIs, PostgreSQL, "Reads analytics rollups, writes moderation changes", "JDBC")
        Rel(AdminAPIs, Elasticsearch, "Queries search health + stats", "REST")
        Rel(AdminAPIs, StorageGateway, "Uploads curated imagery for promotions/public profiles", "HTTPS")
        Rel(Admins, AdminAPIs, "Operates governance UI and APIs", "HTTPS")
        Rel(Users, StripeAPI, "Complete checkout pages hosted by Stripe", "HTTPS Redirect")
        Rel(Users, MetaGraphAPI, "Grant permissions for social feeds via OAuth", "HTTPS Redirect")
        Rel(Users, CloudflareR2Store, "Download exports/screenshots via CDN", "HTTPS")
        Rel(WebFrontend, StripeAPI, "Loads Stripe JS for checkout as needed", "HTTPS")
        Rel(WebFrontend, MetaGraphAPI, "User completes OAuth reauth flows via browser", "HTTPS")
        Rel(WebFrontend, CloudflareR2Store, "Uses CDN-served assets for faster load", "HTTPS")
        Rel(JobWorkers, ScreenshotPool, "Acquire concurrency tokens per SCREENSHOT queue (P12)", "Semaphore")
        Rel(ScreenshotPool, CloudflareR2Store, "Saves thumbnail + full-size WebP images", "S3 API")
        Rel(ScreenshotPool, PostgreSQL, "Records directory_screenshot_versions metadata", "SQL")
        Rel(JobWorkers, ScreenshotPool, "Request capture jobs and release browsers", "In-memory")
        Rel(Admins, OpsTooling, "Review alerts + dashboards outside the app", "HTTPS")
        Rel(QuarkusApp, MailpitSMTP, "Immediate transactional emails (listing published, consent confirmation)", "SMTP")
        Rel(JobWorkers, MailpitSMTP, "Send scheduled reminders and handle inbound replies", "SMTP/IMAP")
        Rel(JobWorkers, Elasticsearch, "Batch indexing operations for new/updated records", "REST")
        Rel(JobWorkers, Elasticsearch, "Rebuild indexes via scheduled job (RankRecalculation)", "REST")
        Rel(JobWorkers, PostgreSQL, "Drop expired partitions (link_clicks, feature_flag_evaluations)", "SQL")
        Rel(QuarkusApp, JaegerTrace, "Send server span data for HTTP requests", "OTLP")
        Rel(JobWorkers, JaegerTrace, "Emit traces for asynchronous pipelines", "OTLP")
        Rel(AdminAPIs, ClickTrackingService, "Fetch aggregated click stats for dashboards", "JDBC")
        Rel(AdminAPIs, OpsTooling, "Push selected metrics to ops systems", "Webhook")
        Rel(Users, ClickTrackingService, "Indirect via /track/click redirects", "HTTPS")
        Lay_D(QuarkusApp, PostgreSQL)
        Lay_D(QuarkusApp, Elasticsearch)
        Lay_D(QuarkusApp, StorageGateway)
        Lay_D(QuarkusApp, LangChainService)
        Lay_D(QuarkusApp, MetaGraphAPI)
        Lay_D(QuarkusApp, StripeAPI)
        Lay_D(JobWorkers, CloudflareR2Store)
        Lay_D(JobWorkers, PostgreSQL)
        Lay_D(JobWorkers, LangChainService)
        Lay_D(ClickTrackingService, PostgreSQL)
        Lay_D(StorageGateway, CloudflareR2Store)
        Lay_D(AdminAPIs, FeatureFlagEngine)
        Lay_D(AdminAPIs, ClickTrackingService)
        Lay_D(AdminAPIs, PostgreSQL)
        Lay_D(AdminAPIs, Elasticsearch)
        Lay_D(AuthIdentity, PostgreSQL)
        Lay_D(WebFrontend, QuarkusApp)
        Lay_D(WebFrontend, StorageGateway)
        Lay_D(WebFrontend, ClickTrackingService)
        Lay_D(WebFrontend, StripeAPI)
        Lay_D(WebFrontend, MetaGraphAPI)
        Lay_D(WebFrontend, CloudflareR2Store)
        Lay_D(WebFrontend, Users)
        @enduml
        ~~~

*   **3.5. Component Diagram (C4 Level 3 - Quarkus Modular Monolith):**
    *   **Description:** This component view zooms into the Quarkus application to reveal domain services, REST resources, integration adapters, and shared utilities defined in the foundation (ExperienceShell, AuthIdentityService, FeedAggregationService, AiTaggingService, MarketplaceService, DirectoryService, ProfileService, ClickTrackingService, StorageGateway, FeatureFlagService, RateLimitService, JobOrchestrator, OpsAnalyticsPortal).
        It highlights dependencies between REST controllers, DTO assemblers, Panache entities, and async job enqueuers so maintainers know exactly where responsibilities sit.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
        LAYOUT_LEFT_RIGHT()
        Container_Boundary(QuarkusBoundary, "Quarkus Modular Monolith") {
          Component(ExperienceShell, "ExperienceShell", "Controllers", "Provides HTML pages, SEO metadata, mounts React islands")
          Component(PublicRest, "Public REST Resources", "RESTEasy", "Serve authenticated/anonymous APIs")
          Component(AdminRest, "Admin REST Resources", "RESTEasy", "Expose analytics, moderation, feature flag management")
          Component(AuthIdentityService, "AuthIdentityService", "Service", "Bootstrap, OAuth login, anonymous merge, consent logging")
          Component(UserPreferenceService, "UserPreferenceService", "Service", "Manages JSONB layouts, topics, watchlists")
          Component(FeedAggregationService, "FeedAggregationService", "Service", "Manages RSS sources, feed ingestion, deduplication")
          Component(AiTaggingService, "AiTaggingService", "Integration", "Batches items for LangChain4j requests")
          Component(AiTaggingBudgetService, "AiTaggingBudgetService", "Policy", "Determines action per P10 thresholds")
          Component(WeatherService, "WeatherService", "Integration", "Fetch Open-Meteo + NWS data, cache results")
          Component(StockService, "StockService", "Integration", "Fetch quotes, enforce Alpha Vantage rate limits")
          Component(SocialIntegrationService, "SocialIntegrationService", "Integration", "Meta Graph API tokens, caching, stale banners")
          Component(MarketplaceService, "MarketplaceService", "Domain", "Listings, categories, payments, PostGIS queries")
          Component(DirectoryService, "DirectoryService", "Domain", "Categories, submissions, voting, screenshots")
          Component(ProfileService, "ProfileService", "Domain", "Public templates, curated articles")
          Component(ClickTrackingServiceComponent, "ClickTrackingService", "Domain", "/track/click endpoint + partitioned logging")
          Component(FeatureFlagServiceComponent, "FeatureFlagService", "Utility", "Stable cohorts, analytics logging, purge")
          Component(RateLimitService, "RateLimitService", "Utility", "Caffeine-backed buckets + violation logging")
          Component(StorageGatewayComponent, "StorageGateway", "Utility", "Cloudflare R2 client, WebP conversion, signed URLs")
          Component(JobOrchestrator, "JobOrchestrator", "Utility", "Schedules + enqueues delayed jobs per queue")
          Component(DelayedJobHandlers, "Delayed Job Handlers", "Handlers", "Feed, weather, stock, social, AI tagging, screenshot, click rollup, cleanup")
          Component(OpsAnalyticsPortal, "OpsAnalyticsPortal", "UI", "Admin dashboards using AntV charts")
          Component(SearchService, "SearchService", "Utility", "Hibernate Search queries against Elasticsearch")
          Component(GeoService, "GeoService", "Utility", "PostGIS helper functions for radius queries")
          Component(PaymentService, "PaymentService", "Integration", "Stripe checkout + webhooks + refunds")
          Component(EmailService, "EmailService", "Utility", "Qute email templates + SMTP sender")
          Component(InboundEmailProcessor, "InboundEmailProcessor", "Job", "Polls IMAP for replies, routes to handlers")
          Component(ScreenshotService, "ScreenshotService", "Integration", "jvppeteer control, browser pool")
          Component(SearchIndexer, "SearchIndexer", "Utility", "Coordinates Hibernate Search indexing")
          Component(AnalyticsExporter, "AnalyticsExporter", "Utility", "Produces CSV/JSON exports for analytics + GDPR")
          Component(ConsentService, "ConsentService", "Utility", "Manages GDPR consent flows + records")
          Component(AuditService, "AuditService", "Utility", "Writes account merge + feature flag audit entries")
          Component(SEOService, "SEOService", "Utility", "Generates SEO meta tags & JSON-LD")
          Component(ComponentRegistry, "Component Mount Registry", "Utility", "maps data-component attributes to React islands")
          Component(ReactMounts, "React Component Bundle", "React 18", "News, weather, stocks, admin charts, profile editors")
          Component(GridstackLayouts, "Gridstack Config", "JS Config", "Shared responsive layout definitions")
          Component(AntVComponents, "AntV Visualization Bundle", "React + G2Plot/S2", "Charts/tables for analytics")
          Component(PuppeteerBrowserPool, "Browser Pool", "jvppeteer", "Chrome instances with semaphore")
        }
        Component_Ext(PostgreSQLComponent, "PostgreSQL 17 + PostGIS", "Database", "Relational persistence + JSONB + GIS")
        Component_Ext(ElasticsearchComponent, "Elasticsearch 8", "Search", "Full-text indices for marketplace/directory")
        Component_Ext(CloudflareR2StoreComponent, "Cloudflare R2", "Storage", "Screenshots, listing media, exports")
        Component_Ext(StripeAPIComponent, "Stripe", "Payments", "Checkout, refunds, disputes")
        Component_Ext(LangChainServiceComponent, "LangChain4j Claude", "AI", "Tagging, categorization, fraud analysis")
        Component_Ext(MailerComponent, "SMTP/IMAP", "Email", "Outbound/inbound email")
        Person(UserComponent, "Authenticated User")
        Person(AnonComponent, "Anonymous Visitor")
        Person(AdminComponent, "Admin/Moderator")
        Rel(AnonComponent, ExperienceShell, "Requests homepage, receives Qute-rendered layout", "HTTPS")
        Rel(UserComponent, ExperienceShell, "Loads personalized layout, triggers React mounts", "HTTPS")
        Rel(AdminComponent, ExperienceShell, "Accesses admin shell + dashboards", "HTTPS")
        Rel(ExperienceShell, ComponentRegistry, "Annotates DOM with data-component + props", "Server rendering")
        Rel(ComponentRegistry, ReactMounts, "Initializes React components via mounts.ts", "Browser runtime")
        Rel(ComponentRegistry, GridstackLayouts, "Supplies responsive config for drag/drop", "JS config")
        Rel(ReactMounts, AntVComponents, "Renders charts/tables using Ant Design visuals", "React")
        Rel(ExperienceShell, SEOService, "Generates meta tags + JSON-LD per page", "Template call")
        Rel(SEOService, ProfileService, "Uses profile data for OG tags/JSON-LD", "DTO")
        Rel(SEOService, MarketplaceService, "Outputs product schema for listings", "DTO")
        Rel(SEOService, DirectoryService, "Builds structured data for category pages", "DTO")
        Rel(SEOService, FeedAggregationService, "Generates WebSite schema for homepage", "DTO")
        Rel(ExperienceShell, PublicRest, "Invokes widget APIs for JSON hydration", "HTTP")
        Rel(ExperienceShell, FeatureFlagServiceComponent, "Asks for flag states to drive template decisions", "In-memory")
        Rel(PublicRest, AuthIdentityService, "Routes login, bootstrap, token refresh requests", "Service call")
        Rel(PublicRest, UserPreferenceService, "CRUD operations for widget layouts/preferences", "Service call")
        Rel(PublicRest, FeedAggregationService, "Fetches user-scoped news DTOs", "Service call")
        Rel(PublicRest, WeatherService, "Obtains weather/warning payloads", "Service call")
        Rel(PublicRest, StockService, "Provides watchlist quotes/sparklines", "Service call")
        Rel(PublicRest, SocialIntegrationService, "Delivers social feed widget data", "Service call")
        Rel(PublicRest, MarketplaceService, "Exposes listing browse/posting APIs", "Service call")
        Rel(PublicRest, DirectoryService, "Exposes Good Sites browsing + voting", "Service call")
        Rel(PublicRest, ProfileService, "Serves public profile data + editing APIs", "Service call")
        Rel(PublicRest, ClickTrackingServiceComponent, "Redirects via /track/click", "HTTP")
        Rel(PublicRest, SearchService, "Uses search queries for marketplace/directory lookups", "Service call")
        Rel(PublicRest, RateLimitService, "Checks per-action buckets before performing writes", "Guard")
        Rel(PublicRest, PaymentService, "Initiates posting fee checkout sessions", "Service call")
        Rel(AdminRest, OpsAnalyticsPortal, "Feeds analytics endpoints with DTOs for AntV charts", "Service call")
        Rel(AdminRest, MarketplaceService, "Moderation + configuration endpoints", "Service call")
        Rel(AdminRest, DirectoryService, "Moderator queue + category management", "Service call")
        Rel(AdminRest, FeatureFlagServiceComponent, "Flag CRUD operations", "Service call")
        Rel(AdminRest, RateLimitService, "Fetch/update rate limit tiers", "Service call")
        Rel(AdminRest, AnalyticsExporter, "Trigger exports + download bundles", "Service call")
        Rel(AdminRest, AiTaggingBudgetService, "Review AI spend + override budget", "Service call")
        Rel(AdminRest, JobOrchestrator, "Manually requeue or pause jobs", "Service call")
        Rel(AdminRest, AuditService, "Logs admin edits for traceability", "Service call")
        Rel(AuthIdentityService, ConsentService, "Captures GDPR consent + analytics preferences", "Service call")
        Rel(AuthIdentityService, AuditService, "Writes account_merge_audit entries", "Service call")
        Rel(AuthIdentityService, JobOrchestrator, "Queues anonymous cleanup + export jobs", "Delayed Job")
        Rel(UserPreferenceService, FeatureFlagServiceComponent, "Stores analytics consent for evaluation purge", "Service call")
        Rel(UserPreferenceService, RateLimitService, "Identifies trusted tier (karma >=10)", "Service call")
        Rel(FeedAggregationService, AiTaggingService, "Submits batch tagging jobs once feeds fetched", "Service call")
        Rel(FeedAggregationService, JobOrchestrator, "Schedules refresh jobs per feed interval", "Delayed Job")
        Rel(AiTaggingService, AiTaggingBudgetService, "Checks allowed action before invoking provider", "Service call")
        Rel(AiTaggingService, LangChainServiceComponent, "Executes prompts via LangChain4j", "HTTPS")
        Rel(AiTaggingService, FeedAggregationService, "Persists ai_tags results", "Service call")
        Rel(AiTaggingService, DirectoryService, "Sends AI category suggestions for submissions", "Service call")
        Rel(AiTaggingService, MarketplaceService, "Feeds fraud heuristics to moderators", "Service call")
        Rel(WeatherService, GeoService, "Resolves city coordinates + provider selection", "Function call")
        Rel(WeatherService, JobOrchestrator, "Schedules hourly refresh jobs", "Delayed Job")
        Rel(StockService, JobOrchestrator, "Schedules HIGH queue jobs for market hours", "Delayed Job")
        Rel(SocialIntegrationService, JobOrchestrator, "Schedules LOW queue refresh + proactive token checks", "Delayed Job")
        Rel(SocialIntegrationService, FeatureFlagServiceComponent, "Ensures social_integration flag gates usage", "Guard")
        Rel(MarketplaceService, GeoService, "Executes PostGIS radius queries", "Function call")
        Rel(MarketplaceService, PaymentService, "Charges posting fees/promotions", "Service call")
        Rel(MarketplaceService, StorageGatewayComponent, "Stores listing images in R2", "Service call")
        Rel(MarketplaceService, RateLimitService, "Applies posting + contact rate limits", "Service call")
        Rel(MarketplaceService, ClickTrackingServiceComponent, "Logs listing views + replies via tracker", "Service call")
        Rel(DirectoryService, ScreenshotService, "Queues screenshot capture jobs", "Service call")
        Rel(DirectoryService, ClickTrackingServiceComponent, "Routes site clicks through tracker", "Service call")
        Rel(DirectoryService, JobOrchestrator, "Schedules rank recalculations + link health checks", "Delayed Job")
        Rel(ProfileService, DirectoryService, "Reuses feed items for curated slots", "Service call")
        Rel(ProfileService, StorageGatewayComponent, "Stores avatars/background imagery", "Service call")
        Rel(ProfileService, ClickTrackingServiceComponent, "Tracks curated link clicks", "Service call")
        Rel(ClickTrackingServiceComponent, JobOrchestrator, "Enqueues rollup + retention jobs", "Delayed Job")
        Rel(ClickTrackingServiceComponent, AnalyticsExporter, "Provides aggregated stats for downloads", "Service call")
        Rel(FeatureFlagServiceComponent, AuditService, "Writes feature_flag_audit entries", "Service call")
        Rel(FeatureFlagServiceComponent, ClickTrackingServiceComponent, "Logs evaluations when analytics enabled", "Service call")
        Rel(RateLimitService, AuditService, "Logs overrides + block actions", "Service call")
        Rel(StorageGatewayComponent, CloudflareR2StoreComponent, "Uploads media via S3 API", "HTTPS")
        Rel(JobOrchestrator, DelayedJobHandlers, "Dispatches payloads to handler classes", "Scheduler")
        Rel(DelayedJobHandlers, PostgreSQLComponent, "Persist/lock delayed_jobs rows", "SQL")
        Rel(DelayedJobHandlers, ScreenshotService, "Call jvppeteer browsers", "Service call")
        Rel(DelayedJobHandlers, EmailService, "Send notifications (expiring listings, approvals)", "Service call")
        Rel(DelayedJobHandlers, StorageGatewayComponent, "Upload processed assets", "Service call")
        Rel(DelayedJobHandlers, SearchIndexer, "Trigger asynchronous indexing", "Service call")
        Rel(SearchIndexer, ElasticsearchComponent, "Push documents via Hibernate Search", "REST")
        Rel(SearchService, ElasticsearchComponent, "Query indices for results", "REST")
        Rel(PaymentService, StripeAPIComponent, "Create sessions, handle webhooks, process refunds", "HTTPS")
        Rel(PaymentService, PostgreSQLComponent, "Persists payment_refunds + promotions", "SQL")
        Rel(EmailService, MailerComponent, "SMTP send + inbound parsing", "SMTP/IMAP")
        Rel(InboundEmailProcessor, MarketplaceService, "Route replies to listing owners via masked tokens", "Service call")
        Rel(InboundEmailProcessor, EmailService, "Marks inbound messages as processed", "Service call")
        Rel(ScreenshotService, StorageGatewayComponent, "Uploads captured WebP images + thumbnails", "Service call")
        Rel(ScreenshotService, DirectoryService, "Updates screenshot metadata + version numbers", "Service call")
        Rel(ScreenshotService, PuppeteerBrowserPool, "Leases Chrome instances per pool size", "Semaphore")
        Rel(AnalyticsExporter, StorageGatewayComponent, "Writes export bundles to R2", "Service call")
        Rel(AnalyticsExporter, JobOrchestrator, "Schedules asynchronous export builds", "Delayed Job")
        Rel(OpsAnalyticsPortal, AntVComponents, "Renders charts/tables from admin APIs", "React")
        Rel(OpsAnalyticsPortal, ClickTrackingServiceComponent, "Displays daily trends + top items", "Service call")
        Rel(OpsAnalyticsPortal, JobOrchestrator, "Shows queue health metrics", "Service call")
        Rel(OpsAnalyticsPortal, AiTaggingBudgetService, "Shows AI spend gauge", "Service call")
        Rel(OpsAnalyticsPortal, RateLimitService, "Displays violation counts, enables overrides", "Service call")
        Rel(ConsentService, FeatureFlagServiceComponent, "Tells evaluation logic whether analytics logging allowed", "Service call")
        Rel(AuditService, PostgreSQLComponent, "Stores audit records for merges + flags", "SQL")
        Rel(ConsentService, PostgreSQLComponent, "Stores consent timestamps + jurisdictions", "SQL")
        Rel(UserPreferenceService, PostgreSQLComponent, "Reads/writes preferences JSONB", "SQL")
        Rel(FeedAggregationService, PostgreSQLComponent, "Reads/writes rss_sources + feed_items", "SQL")
        Rel(MarketplaceService, PostgreSQLComponent, "CRUD for listings, categories, promotions", "SQL")
        Rel(DirectoryService, PostgreSQLComponent, "CRUD for categories, sites, votes", "SQL")
        Rel(ProfileService, PostgreSQLComponent, "CRUD for user_profiles + curated articles", "SQL")
        Rel(ClickTrackingServiceComponent, PostgreSQLComponent, "Writes link_clicks partitions", "SQL")
        Rel(SearchService, PostgreSQLComponent, "Fallback queries when Elasticsearch unavailable", "SQL")
        Rel(GeoService, PostgreSQLComponent, "Maintains geo_cities data + indexes", "SQL")
        Rel(EmailService, PostgreSQLComponent, "Stores inbound_emails log", "SQL")
        Rel(InboundEmailProcessor, PostgreSQLComponent, "Persists inbound email metadata", "SQL")
        Rel(ScreenshotService, PostgreSQLComponent, "Stores directory_screenshot_versions", "SQL")
        Rel(AnalyticsExporter, PostgreSQLComponent, "Reads aggregated stats from click_stats tables", "SQL")
        Rel(JobOrchestrator, RateLimitService, "Monitors job scheduling so rate-limited tasks respect quotas", "Service call")
        Rel(JobOrchestrator, FeatureFlagServiceComponent, "Evaluates queue enabling flags before dispatch", "Service call")
        Rel(StorageGatewayComponent, RateLimitService, "Protects against abuse when uploading media", "Guard")
        Rel(AdminRest, RateLimitService, "Allows overrides for blocked users/IPs", "Service call")
        Rel(OpsAnalyticsPortal, ElasticsearchComponent, "Displays cluster health + index stats", "REST")
        Rel(OpsAnalyticsPortal, PostgreSQLComponent, "Aggregates job metrics + audit trails", "SQL")
        Rel(OpsAnalyticsPortal, StorageGatewayComponent, "Links to exported bundles", "S3")
        Rel(UserPreferenceService, ExperienceShell, "Provides theme + layout DTOs for rendering", "DTO")
        Rel(ExperienceShell, AuthIdentityService, "Displays bootstrap + login flows based on system state", "DTO")
        Rel(AdminRest, ScreenshotService, "Allow manual re-capture for Good Sites entries", "Service call")
        Rel(AdminRest, SearchIndexer, "Kick off reindex operations", "Service call")
        Rel(AdminRest, GeoService, "Manage location dataset refresh if needed", "Service call")
        Rel(AdminRest, PaymentService, "Issue manual refunds/resolutions", "Service call")
        Rel(AdminRest, EmailService, "Send moderator notifications", "Service call")
        Rel(AdminRest, AnalyticsExporter, "Generate CSV/JSON for BI", "Service call")
        Rel(OpsAnalyticsPortal, FeatureFlagServiceComponent, "Shows evaluation counts + states", "Service call")
        Rel(ConsentService, ProfileService, "Ensures public data respects privacy toggles", "Service call")
        Rel(UserPreferenceService, ProfileService, "Share theme + layout defaults", "Service call")
        Rel(MarketplaceService, OpsAnalyticsPortal, "Provides listing metrics for dashboards", "Service call")
        Rel(DirectoryService, OpsAnalyticsPortal, "Provides voting trends + flag counts", "Service call")
        Rel(ProfileService, OpsAnalyticsPortal, "Provides profile view stats", "Service call")
        Lay_D(ExperienceShell, PublicRest)
        Lay_D(PublicRest, MarketplaceService)
        Lay_D(PublicRest, DirectoryService)
        Lay_D(PublicRest, ProfileService)
        Lay_D(PublicRest, FeedAggregationService)
        Lay_D(PublicRest, WeatherService)
        Lay_D(PublicRest, StockService)
        Lay_D(PublicRest, SocialIntegrationService)
        Lay_D(PublicRest, ClickTrackingServiceComponent)
        Lay_D(AdminRest, OpsAnalyticsPortal)
        Lay_D(AdminRest, FeatureFlagServiceComponent)
        Lay_D(AdminRest, RateLimitService)
        Lay_D(AdminRest, AnalyticsExporter)
        Lay_D(AiTaggingService, AiTaggingBudgetService)
        Lay_D(MarketplaceService, PaymentService)
        Lay_D(MarketplaceService, StorageGatewayComponent)
        Lay_D(DirectoryService, ScreenshotService)
        Lay_D(ProfileService, StorageGatewayComponent)
        Lay_D(ClickTrackingServiceComponent, JobOrchestrator)
        Lay_D(JobOrchestrator, DelayedJobHandlers)
        Lay_D(DelayedJobHandlers, ScreenshotService)
        Lay_D(DelayedJobHandlers, EmailService)
        Lay_D(DelayedJobHandlers, SearchIndexer)
        Lay_D(ExperienceShell, SEOService)
        Lay_D(SEOService, DirectoryService)
        Lay_D(SEOService, MarketplaceService)
        Lay_D(SEOService, ProfileService)
        Lay_D(SEOService, FeedAggregationService)
        Lay_D(OpsAnalyticsPortal, AiTaggingBudgetService)
        Lay_D(OpsAnalyticsPortal, RateLimitService)
        Lay_D(OpsAnalyticsPortal, ClickTrackingServiceComponent)
        Lay_D(OpsAnalyticsPortal, JobOrchestrator)
        Lay_D(OpsAnalyticsPortal, FeatureFlagServiceComponent)
        Lay_D(OpsAnalyticsPortal, StorageGatewayComponent)
        Lay_D(RateLimitService, AuditService)
        Lay_D(PaymentService, AuditService)
        Lay_D(AuditService, PostgreSQLComponent)
        Lay_D(ConsentService, PostgreSQLComponent)
        Lay_D(AnalyticsExporter, StorageGatewayComponent)
        Lay_D(InboundEmailProcessor, MarketplaceService)
        Lay_D(InboundEmailProcessor, EmailService)
        Lay_D(StorageGatewayComponent, CloudflareR2StoreComponent)
        Lay_D(FeatureFlagServiceComponent, PostgreSQLComponent)
        Lay_D(MarketplaceService, GeoService)
        Lay_D(WeatherService, GeoService)
        Lay_D(ProfileService, DirectoryService)
        Lay_D(ProfileService, FeedAggregationService)
        Lay_D(ProfileService, AiTaggingService)
        Lay_D(ProfileService, ClickTrackingServiceComponent)
        Lay_D(AiTaggingService, LangChainServiceComponent)
        Lay_D(ScreenshotService, PuppeteerBrowserPool)
        @enduml
        ~~~

*   **3.6. Data Model Overview & ERD:**
    *   **Description:** The core schema leverages PostgreSQL 17 with JSONB-heavy tables, PostGIS geography columns, audit trails, AI cost tracking, partitioned click logs, and versioned screenshot records so every policy mandate has a durable representation.
        Entities span users/preferences, RSS feeds/items, AI usage, weather cache, stocks, social tokens/posts, marketplace categories/listings/images/promotions/messages, Good Sites categories/sites/votes/flags/moderators, user profiles/curated articles, feature flags/audits/evaluations, delayed jobs, click tracking tables, analytics rollups, rate limit config/violations, payments/refunds, screenshot versions, and supporting reference data.
    *   **Key Entities:** users, account_merge_audit, rss_sources, feed_items, ai_usage_tracking, weather_cache, stock_quotes, social_tokens, social_posts, marketplace_categories, marketplace_listings, marketplace_listing_images, listing_promotions, payment_refunds, marketplace_messages, rss_user_subscriptions, geo_cities, directory_categories, directory_sites, directory_site_categories, directory_votes, directory_flags, directory_category_moderators, user_profiles, profile_curated_articles, feature_flags, feature_flag_audit, feature_flag_evaluations, delayed_jobs, link_clicks, click_stats_daily, click_stats_daily_items, rate_limit_config, rate_limit_violations, inbound_emails, directory_screenshot_versions.
    *   **Diagram (PlantUML - ERD):**
        ~~~plantuml
        @startuml
        !theme plain
        entity "users" as users {
          * id : UUID
          email : TEXT
          oauth_provider : TEXT
          oauth_id : TEXT
          display_name : TEXT
          avatar_url : TEXT
          preferences : JSONB
          is_anonymous : BOOLEAN
          directory_karma : INT
          directory_trust_level : TEXT
          analytics_consent : BOOLEAN
          last_active_at : TIMESTAMPTZ
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "account_merge_audit" as account_merge_audit {
          * id : UUID
          anonymous_user_id : UUID
          authenticated_user_id : UUID
          merged_data_summary : JSONB
          consent_given : BOOLEAN
          consent_timestamp : TIMESTAMPTZ
          ip_address : INET
          user_agent : TEXT
          purge_after : TIMESTAMPTZ
          created_at : TIMESTAMPTZ
        }
        entity "rss_sources" as rss_sources {
          * id : UUID
          name : TEXT
          url : TEXT
          category : TEXT
          is_system : BOOLEAN
          user_id : UUID
          refresh_interval_minutes : INT
          status : TEXT
          last_fetched_at : TIMESTAMPTZ
          error_count : INT
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "feed_items" as feed_items {
          * id : UUID
          source_id : UUID
          title : TEXT
          url : TEXT
          description : TEXT
          image_url : TEXT
          published_at : TIMESTAMPTZ
          ai_tags : JSONB
          fetched_at : TIMESTAMPTZ
          created_at : TIMESTAMPTZ
        }
        entity "rss_user_subscriptions" as rss_user_subscriptions {
          * id : UUID
          user_id : UUID
          source_id : UUID
          created_at : TIMESTAMPTZ
        }
        entity "ai_usage_tracking" as ai_usage_tracking {
          * id : UUID
          month : DATE
          provider : TEXT
          total_requests : INT
          total_tokens_input : BIGINT
          total_tokens_output : BIGINT
          estimated_cost_cents : INT
          budget_limit_cents : INT
          updated_at : TIMESTAMPTZ
        }
        entity "weather_cache" as weather_cache {
          * id : UUID
          location_key : TEXT
          provider : TEXT
          current_data : JSONB
          forecast_data : JSONB
          alerts : JSONB
          fetched_at : TIMESTAMPTZ
          expires_at : TIMESTAMPTZ
        }
        entity "stock_quotes" as stock_quotes {
          * id : UUID
          symbol : TEXT
          company_name : TEXT
          price : NUMERIC
          change : NUMERIC
          change_percent : NUMERIC
          market_cap : NUMERIC
          sparkline : JSONB
          updated_at : TIMESTAMPTZ
        }
        entity "social_tokens" as social_tokens {
          * id : UUID
          user_id : UUID
          provider : TEXT
          access_token : TEXT
          refresh_token : TEXT
          expires_at : TIMESTAMPTZ
          scopes : TEXT
          last_refresh_attempt : TIMESTAMPTZ
          status : TEXT
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "social_posts" as social_posts {
          * id : UUID
          user_id : UUID
          provider : TEXT
          external_id : TEXT
          content : JSONB
          media_url : TEXT
          engagement_metrics : JSONB
          posted_at : TIMESTAMPTZ
          fetched_at : TIMESTAMPTZ
          is_archived : BOOLEAN
        }
        entity "marketplace_categories" as marketplace_categories {
          * id : UUID
          parent_id : UUID
          name : TEXT
          slug : TEXT
          sort_order : INT
          is_active : BOOLEAN
          fee_schedule : JSONB
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "geo_cities" as geo_cities {
          * id : INT
          state_id : INT
          country_id : INT
          name : TEXT
          latitude : NUMERIC
          longitude : NUMERIC
          timezone : TEXT
          location : GEOGRAPHY(Point,4326)
        }
        entity "marketplace_listings" as marketplace_listings {
          * id : UUID
          user_id : UUID
          category_id : UUID
          city_id : INT
          title : TEXT
          description : TEXT
          price : NUMERIC
          is_free : BOOLEAN
          contact_for_price : BOOLEAN
          latitude : NUMERIC
          longitude : NUMERIC
          location_text : TEXT
          contact_email_masked : TEXT
          contact_phone : TEXT
          status : TEXT
          view_count : BIGINT
          reply_count : BIGINT
          flag_count : BIGINT
          expires_at : TIMESTAMPTZ
          published_at : TIMESTAMPTZ
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "marketplace_listing_images" as marketplace_listing_images {
          * id : UUID
          listing_id : UUID
          storage_key : TEXT
          original_filename : TEXT
          content_type : TEXT
          size_bytes : BIGINT
          width : INT
          height : INT
          sort_order : INT
          created_at : TIMESTAMPTZ
        }
        entity "listing_promotions" as listing_promotions {
          * id : UUID
          listing_id : UUID
          type : TEXT
          stripe_payment_intent_id : TEXT
          amount_cents : INT
          starts_at : TIMESTAMPTZ
          expires_at : TIMESTAMPTZ
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "payment_refunds" as payment_refunds {
          * id : UUID
          stripe_payment_intent_id : TEXT
          stripe_refund_id : TEXT
          listing_id : UUID
          user_id : UUID
          amount_cents : INT
          reason : TEXT
          status : TEXT
          reviewed_by_user_id : UUID
          review_notes : TEXT
          created_at : TIMESTAMPTZ
          processed_at : TIMESTAMPTZ
        }
        entity "marketplace_messages" as marketplace_messages {
          * id : UUID
          listing_id : UUID
          from_user_id : UUID
          to_user_id : UUID
          masked_email_token : TEXT
          subject : TEXT
          body : TEXT
          is_read : BOOLEAN
          created_at : TIMESTAMPTZ
        }
        entity "directory_categories" as directory_categories {
          * id : UUID
          parent_id : UUID
          name : TEXT
          slug : TEXT
          description : TEXT
          icon_url : TEXT
          sort_order : INT
          link_count : INT
          is_active : BOOLEAN
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "directory_sites" as directory_sites {
          * id : UUID
          url : TEXT
          domain : TEXT
          title : TEXT
          description : TEXT
          screenshot_url : TEXT
          screenshot_captured_at : TIMESTAMPTZ
          og_image_url : TEXT
          favicon_url : TEXT
          custom_image_url : TEXT
          submitted_by_user_id : UUID
          status : TEXT
          last_checked_at : TIMESTAMPTZ
          is_dead : BOOLEAN
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "directory_site_categories" as directory_site_categories {
          * id : UUID
          site_id : UUID
          category_id : UUID
          score : INT
          upvotes : INT
          downvotes : INT
          rank_in_category : INT
          submitted_by_user_id : UUID
          approved_by_user_id : UUID
          status : TEXT
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "directory_votes" as directory_votes {
          * id : UUID
          site_category_id : UUID
          user_id : UUID
          vote : SMALLINT
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "directory_flags" as directory_flags {
          * id : UUID
          site_category_id : UUID
          user_id : UUID
          reason : TEXT
          details : TEXT
          created_at : TIMESTAMPTZ
          resolved_at : TIMESTAMPTZ
        }
        entity "directory_category_moderators" as directory_category_moderators {
          * id : UUID
          category_id : UUID
          user_id : UUID
          granted_by_user_id : UUID
          created_at : TIMESTAMPTZ
        }
        entity "user_profiles" as user_profiles {
          * id : UUID
          user_id : UUID
          username : TEXT
          display_name : TEXT
          bio : TEXT
          avatar_url : TEXT
          location_text : TEXT
          website_url : TEXT
          social_links : JSONB
          template : TEXT
          template_config : JSONB
          is_published : BOOLEAN
          view_count : BIGINT
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "profile_curated_articles" as profile_curated_articles {
          * id : UUID
          profile_id : UUID
          feed_item_id : UUID
          original_url : TEXT
          original_title : TEXT
          original_description : TEXT
          original_image_url : TEXT
          custom_headline : TEXT
          custom_blurb : TEXT
          custom_image_url : TEXT
          slot_assignment : JSONB
          is_active : BOOLEAN
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "feature_flags" as feature_flags {
          * id : UUID
          key : TEXT
          name : TEXT
          description : TEXT
          is_enabled : BOOLEAN
          rollout_percentage : INT
          user_whitelist : JSONB
          purpose : TEXT
          analytics_enabled : BOOLEAN
          updated_by_user_id : UUID
          updated_at : TIMESTAMPTZ
          created_at : TIMESTAMPTZ
        }
        entity "feature_flag_audit" as feature_flag_audit {
          * id : UUID
          flag_id : UUID
          changed_by_user_id : UUID
          previous_state : JSONB
          new_state : JSONB
          change_reason : TEXT
          created_at : TIMESTAMPTZ
        }
        entity "feature_flag_evaluations" as feature_flag_evaluations {
          * id : UUID
          flag_key : TEXT
          user_id : UUID
          session_hash : TEXT
          is_authenticated : BOOLEAN
          result : BOOLEAN
          evaluated_at : TIMESTAMPTZ
          partition_key : DATE
        }
        entity "delayed_jobs" as delayed_jobs {
          * id : UUID
          queue : TEXT
          handler_class : TEXT
          payload : JSONB
          run_at : TIMESTAMPTZ
          locked_at : TIMESTAMPTZ
          locked_by : TEXT
          attempts : INT
          last_error : TEXT
          failed_at : TIMESTAMPTZ
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "link_clicks" as link_clicks {
          * id : UUID
          click_date : DATE
          click_timestamp : TIMESTAMPTZ
          click_type : TEXT
          target_id : UUID
          target_url : TEXT
          user_id : UUID
          session_id : TEXT
          ip_address : INET
          user_agent : TEXT
          referer : TEXT
          category_id : UUID
        }
        entity "click_stats_daily" as click_stats_daily {
          * id : UUID
          stat_date : DATE
          click_type : TEXT
          category_id : UUID
          category_name : TEXT
          total_clicks : BIGINT
          unique_users : BIGINT
          unique_sessions : BIGINT
          created_at : TIMESTAMPTZ
          updated_at : TIMESTAMPTZ
        }
        entity "click_stats_daily_items" as click_stats_daily_items {
          * id : UUID
          stat_date : DATE
          click_type : TEXT
          target_id : UUID
          target_title : TEXT
          target_url : TEXT
          category_id : UUID
          total_clicks : BIGINT
          unique_users : BIGINT
          created_at : TIMESTAMPTZ
        }
        entity "rate_limit_config" as rate_limit_config {
          * id : UUID
          action_type : TEXT
          tier : TEXT
          limit_count : INT
          window_seconds : INT
          updated_by_user_id : UUID
          updated_at : TIMESTAMPTZ
        }
        entity "rate_limit_violations" as rate_limit_violations {
          * id : UUID
          user_id : UUID
          ip_address : INET
          action_type : TEXT
          endpoint : TEXT
          violation_count : INT
          first_violation_at : TIMESTAMPTZ
          last_violation_at : TIMESTAMPTZ
        }
        entity "inbound_emails" as inbound_emails {
          * id : UUID
          from_address : TEXT
          to_address : TEXT
          subject : TEXT
          body_text : TEXT
          body_html : TEXT
          message_id : TEXT
          in_reply_to : TEXT
          processed_at : TIMESTAMPTZ
          error_message : TEXT
          created_at : TIMESTAMPTZ
        }
        entity "directory_screenshot_versions" as directory_screenshot_versions {
          * id : UUID
          site_id : UUID
          version_number : INT
          storage_key_thumbnail : TEXT
          storage_key_full : TEXT
          captured_at : TIMESTAMPTZ
          file_size_bytes : BIGINT
          is_current : BOOLEAN
          created_at : TIMESTAMPTZ
        }
        account_merge_audit -- users : Many merges belong to a user
        account_merge_audit -- users : Anonymous record reference
        rss_sources -- users : Custom feeds per user
        feed_items -- rss_sources : Items belong to a source
        rss_user_subscriptions -- users : Subscription per user
        rss_user_subscriptions -- rss_sources : Subscription per source
        social_tokens -- users : Each social token tied to user
        social_posts -- users : Posts cached per user
        marketplace_categories -- marketplace_categories : Category hierarchy
        marketplace_listings -- users : Listing owner
        marketplace_listings -- marketplace_categories : Listing category
        marketplace_listings -- geo_cities : Location reference
        marketplace_listing_images -- marketplace_listings : Images per listing
        listing_promotions -- marketplace_listings : Promotion parent
        payment_refunds -- marketplace_listings : Refund listing
        payment_refunds -- users : Refund target user
        payment_refunds -- users : Admin reviewer
        marketplace_messages -- marketplace_listings : Message context
        marketplace_messages -- users : Sender
        marketplace_messages -- users : Recipient
        directory_categories -- directory_categories : Category hierarchy
        directory_sites -- users : Submitter
        directory_site_categories -- directory_sites : Site membership
        directory_site_categories -- directory_categories : Category membership
        directory_votes -- directory_site_categories : Votes per site/category
        directory_votes -- users : Voting user
        directory_flags -- directory_site_categories : Flag context
        directory_flags -- users : Flagger
        directory_category_moderators -- directory_categories : Moderator scope
        directory_category_moderators -- users : Moderator user
        directory_category_moderators -- users : Granting admin
        user_profiles -- users : Profile owner
        profile_curated_articles -- user_profiles : Article placement
        profile_curated_articles -- feed_items : Optional source article
        feature_flags -- users : Flag maintainer
        feature_flag_audit -- feature_flags : Audit scope
        feature_flag_audit -- users : Actor
        feature_flag_evaluations -- feature_flags : Evaluation target
        feature_flag_evaluations -- users : Evaluated user
        rate_limit_config -- users : Rate limit maintainer
        rate_limit_violations -- users : Violation actor
        inbound_emails -- marketplace_messages : Linked via masked token
        directory_screenshot_versions -- directory_sites : Screenshot per site
        @enduml
        ~~~

---

<!-- anchor: structural-data-architect-output-guidelines -->
## Structural & Data Architect Output - `02_System_Structure_and_Data.md`

| Project Scale | Line Count | Diagram Complexity |
|---------------|------------|-------------------|
| **Small** | 200-350 lines | - 1 Context diagram (30-40 lines)<br>- 1 Container diagram (40-60 lines)<br>- Simple ERD (20-30 lines)<br>- Minimal component detail |
| **Medium** | 500-800 lines | - Context diagram (50-70 lines)<br>- Container diagram (80-120 lines)<br>- Component diagram (60-100 lines)<br>- Detailed ERD (40-80 lines) |
| **Large** | 1000-1500 lines | - Complex Context (80-120 lines)<br>- Multiple Container views (150-250 lines)<br>- 2-3 Component diagrams (200-300 lines)<br>- Comprehensive ERD (100-150 lines) |
| **Enterprise** | 1800-2500 lines | - Enterprise Context (150-200 lines)<br>- Multiple system boundaries (300-400 lines)<br>- 4-6 Component diagrams (400-600 lines)<br>- Multi-schema ERD (200-300 lines) |

**Content Distribution:**
- Introduction & Goals: 10-15%
- Architectural Drivers: 10-15%
- Diagrams (PlantUML): 50-60%
- Descriptions & Explanations: 20-25%

**Quality Guidelines:**
- MUST adhere to the specified line count range. Diagram content MUST be 50-60% of total lines. All required diagrams (Context, Container, Component, ERD) are MANDATORY. Outputs below minimum are INCOMPLETE. Outputs above maximum are OVER-DETAILED.

