# Village Homepage - Development Services Stack
# This compose file provides all backing services for local development:
# - PostgreSQL 17 with PostGIS extension
# - Elasticsearch 8 for Hibernate Search
# - MinIO for S3-compatible object storage
# - Mailpit for SMTP testing
# - Jaeger for distributed tracing
#
# Usage:
#   1. Copy .env.example to .env and customize as needed
#   2. Run: docker-compose up -d
#   3. Verify health: docker-compose ps
#   4. Run migrations: cd migrations && mvn migration:up -Dmigration.env=development
#   5. Load geo data: ./scripts/load-geo-data.sh
#
# See docs/ops/dev-services.md for detailed troubleshooting and operational guidance.

networks:
  village-homepage-dev:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  elasticsearch-data:
    driver: local
  minio-data:
    driver: local

services:
  # PostgreSQL 17 with PostGIS extension (P6)
  # Primary relational database with geospatial capabilities for marketplace radius filtering
  # Note: ARM64/Apple Silicon users - see docs/ops/arm64-compatibility.md for native alternatives
  postgres:
    image: postgis/postgis:17-3.5
    platform: linux/amd64
    container_name: village-homepage-postgres
    restart: unless-stopped
    networks:
      - village-homepage-dev
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-village_homepage}
      POSTGRES_USER: ${POSTGRES_USER:-village}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-village_dev_pass}
      # Enable PostGIS extension on startup
      POSTGRES_INITDB_ARGS: "-E UTF8"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./migrations/bootstrap/init-postgis.sql:/docker-entrypoint-initdb.d/01-init-postgis.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-village} -d ${POSTGRES_DB:-village_homepage}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Elasticsearch 8 for Hibernate Search indices (P6)
  # Full-text search on listings and directory sites with geo-spatial filtering
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.2
    platform: linux/amd64
    container_name: village-homepage-elasticsearch
    restart: unless-stopped
    networks:
      - village-homepage-dev
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.name=village-homepage-dev
      - node.name=es-node-1
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # MinIO - S3-compatible object storage (dev equivalent of Cloudflare R2)
  # Stores listing images and screenshot captures
  minio:
    image: minio/minio:latest
    container_name: village-homepage-minio
    restart: unless-stopped
    networks:
      - village-homepage-dev
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # MinIO Client - Initialize buckets on startup
  minio-init:
    image: minio/mc:latest
    platform: linux/amd64
    container_name: village-homepage-minio-init
    networks:
      - village-homepage-dev
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin};
      mc mb --ignore-existing local/screenshots;
      mc mb --ignore-existing local/listings;
      mc anonymous set download local/screenshots;
      mc anonymous set download local/listings;
      echo 'MinIO buckets initialized: screenshots, listings';
      exit 0;
      "

  # Mailpit - SMTP testing with web UI (dev equivalent of production SMTP relay)
  # Captures all outbound emails for local testing
  mailpit:
    image: axllent/mailpit:latest
    container_name: village-homepage-mailpit
    restart: unless-stopped
    networks:
      - village-homepage-dev
    ports:
      - "${MAILPIT_SMTP_PORT:-1025}:1025"
      - "${MAILPIT_UI_PORT:-8025}:8025"
    environment:
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    volumes:
      - ./data/mailpit:/data
    healthcheck:
      test: ["CMD", "/bin/sh", "-c", "busybox wget --spider -q http://localhost:8025/api/v1/info || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Jaeger - Distributed tracing (dev equivalent of centralized Jaeger cluster)
  # Collects OpenTelemetry traces from Quarkus application
  jaeger:
    image: jaegertracing/all-in-one:1.53
    platform: linux/amd64
    container_name: village-homepage-jaeger
    restart: unless-stopped
    networks:
      - village-homepage-dev
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"          # UI
      - "${JAEGER_COLLECTOR_PORT:-4317}:4317"      # OTLP gRPC
      - "${JAEGER_COLLECTOR_HTTP_PORT:-4318}:4318" # OTLP HTTP
      - "5778:5778"                                 # Config server
      - "14268:14268"                               # Jaeger collector
      - "14250:14250"                               # Jaeger gRPC
    environment:
      COLLECTOR_OTLP_ENABLED: true
      LOG_LEVEL: info
    healthcheck:
      test: ["CMD", "/bin/sh", "-c", "busybox wget --spider -q http://localhost:16686 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
