# Test configuration for BaseIntegrationTest with PostgreSQL 17 + PostGIS Testcontainers
# Ref: Foundation Blueprint Section 3.5 (Testing Strategy)
# Task: I1.T2 - BaseIntegrationTest infrastructure

# CRITICAL: Override .env datasource configuration to force Dev Services usage
# .env file contains QUARKUS_DATASOURCE_JDBC_URL which prevents Dev Services from using Testcontainers
# Solution: Unset environment variables via maven-surefire-plugin (see pom.xml)
# DO NOT set quarkus.datasource.jdbc.url here - leave it undefined so Dev Services can activate

# Database Configuration - Quarkus Dev Services with Testcontainers PostgreSQL 17
# NOTE: Must explicitly set db-kind to postgresql to override quarkus-test-h2 dependency
quarkus.datasource.db-kind=postgresql
# NOTE: username, password, and jdbc.url are auto-configured by Dev Services (Testcontainers)
# DO NOT set them here - Dev Services needs them undefined to activate
quarkus.datasource.jdbc.driver=org.postgresql.Driver

# Enable Dev Services for automatic Testcontainers management
quarkus.datasource.devservices.enabled=true
quarkus.datasource.devservices.image-name=postgis/postgis:17-3.5-alpine
# NOTE: PostGIS extensions are pre-installed in postgis/postgis image, no init script needed

# Hibernate ORM Configuration
quarkus.hibernate-orm.database.generation=drop-and-create
quarkus.hibernate-orm.log.sql=true
quarkus.hibernate-orm.sql-load-script=no-file
# Disable database version check to allow H2 emulation mode in legacy tests
# New tests using BaseIntegrationTest will use PostgreSQL Testcontainers
%test.quarkus.hibernate-orm.database.version-check.enabled=false
# CRITICAL: Enable Jackson for JSONB type handling (fixes HashMap serialization to JSONB)
quarkus.hibernate-orm.mapping.jackson.convert-to-json-mode=enabled

# Logging
quarkus.log.level=WARN
quarkus.log.category."villagecompute.homepage".level=INFO
quarkus.log.category."org.testcontainers".level=INFO

# Disable OIDC security for tests
quarkus.oidc.enabled=false
quarkus.security.auth.enabled-in-dev-mode=false
quarkus.security.jpa.enabled=false

# Disable Hibernate Search Elasticsearch for tests
quarkus.hibernate-search-orm.enabled=false

# Disable OpenTelemetry for tests
quarkus.otel.sdk.disabled=true

# Auth configuration for tests
villagecompute.auth.cookie.name=vu_anon_id
villagecompute.auth.cookie.secure=true
villagecompute.auth.cookie.http-only=true
villagecompute.auth.cookie.same-site=Lax
villagecompute.auth.cookie.max-age=31536000
villagecompute.auth.bootstrap.token=test-bootstrap-token
villagecompute.auth.bootstrap.admin-exists=false
villagecompute.auth.jwt.secret=unit-test-signing-secret
villagecompute.auth.jwt.issuer=test-suite
villagecompute.auth.jwt.audience=village-homepage-test
villagecompute.auth.jwt.expiration-minutes=30
villagecompute.auth.rate-limit.bootstrap.max-requests=5
villagecompute.auth.rate-limit.bootstrap.window-seconds=3600
villagecompute.auth.rate-limit.login.max-requests=20
villagecompute.auth.rate-limit.login.window-seconds=60

# Alpha Vantage API (test key)
alphavantage.api-key=test-api-key

# Stripe API keys (test values)
stripe.secret-key=sk_test_dummy_for_tests
stripe.webhook-secret=whsec_test_dummy_for_tests

# Email IMAP configuration (test values)
email.imap.host=localhost
email.imap.port=1143
email.imap.username=test@example.com
email.imap.password=test_placeholder
email.imap.folder=INBOX
email.imap.poll-interval-seconds=60

# LangChain4j configuration for tests
# Specify providers: Anthropic for chat, OpenAI for embeddings
quarkus.langchain4j.chat-model.provider=anthropic
quarkus.langchain4j.embedding-model.provider=openai
# Anthropic chat model config (mocked in tests via @InjectMock)
quarkus.langchain4j.anthropic.api-key=sk-ant-test-dummy-key-00000000000000000000000000000000
quarkus.langchain4j.anthropic.chat-model.model-name=claude-3-5-sonnet-20241022
# OpenAI embedding model config (mocked in tests via @InjectMock)
# Note: Anthropic doesn't provide embedding models; using OpenAI
quarkus.langchain4j.openai.api-key=sk-proj-test-dummy-key-0000000000000000000000000000000000000000000000
quarkus.langchain4j.openai.embedding-model.model-name=text-embedding-3-small

# AI Model Configuration (Feature I4.T6)
ai.model.sonnet.name=claude-3-5-sonnet-20241022
ai.model.haiku.name=claude-3-haiku-20240307
ai.model.temperature=0.7
ai.model.max-tokens=4096
ai.model.timeout-seconds=60
ai.model.max-retries=3
