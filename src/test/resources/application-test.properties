# Test configuration for BaseIntegrationTest with PostgreSQL 17 + PostGIS
# Ref: Foundation Blueprint Section 3.5 (Testing Strategy)
# Task: I1.T2 - BaseIntegrationTest infrastructure

# Database Configuration - Use environment variables or fallback to local docker-compose
# In CI: env vars are set by GitHub Actions workflow (QUARKUS_DATASOURCE_*)
# Locally: use PostgreSQLTestResource which starts a Testcontainer
quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.driver=org.postgresql.Driver

# Disable DevServices - we use either:
# 1. CI service container (GitHub Actions sets QUARKUS_DATASOURCE_JDBC_URL)
# 2. PostgreSQLTestResource for local runs (explicitly manages Testcontainers)
quarkus.datasource.devservices.enabled=false

# Fallback values for local development (overridden by env vars in CI)
quarkus.datasource.jdbc.url=${QUARKUS_DATASOURCE_JDBC_URL:jdbc:postgresql://localhost:5432/homepage_test}
quarkus.datasource.username=${QUARKUS_DATASOURCE_USERNAME:test}
quarkus.datasource.password=${QUARKUS_DATASOURCE_PASSWORD:test}

# Hibernate ORM Configuration
# Use 'none' since migrations handle schema creation
# In CI: migrations run before tests; locally: PostgreSQLTestResource + migrations
quarkus.hibernate-orm.database.generation=${QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION:drop-and-create}
quarkus.hibernate-orm.log.sql=true
quarkus.hibernate-orm.sql-load-script=no-file
# Disable database version check for flexibility
quarkus.hibernate-orm.database.version-check.enabled=false
# CRITICAL: Enable Jackson for JSONB type handling (fixes HashMap serialization to JSONB)
quarkus.hibernate-orm.mapping.jackson.convert-to-json-mode=enabled
# Ignore global format mapping to prevent JSON serialization conflicts
quarkus.hibernate-orm.mapping.format.global=ignore

# Logging
quarkus.log.level=WARN
quarkus.log.category."villagecompute.homepage".level=INFO
quarkus.log.category."org.testcontainers".level=INFO

# Disable OIDC security for tests
quarkus.oidc.enabled=false
quarkus.security.auth.enabled-in-dev-mode=false
quarkus.security.jpa.enabled=false

# OAuth provider dummy configuration for tests (required by OIDC extension even when disabled)
quarkus.oidc.apple.client-id=test-apple-client-id
quarkus.oidc.apple.credentials.secret=test-apple-secret
quarkus.oidc.google.client-id=test-google-client-id
quarkus.oidc.google.credentials.secret=test-google-secret
quarkus.oidc.facebook.client-id=test-facebook-client-id
quarkus.oidc.facebook.credentials.secret=test-facebook-secret

# Disable Hibernate Search Elasticsearch for tests
quarkus.hibernate-search-orm.enabled=false

# Disable OpenTelemetry for tests
quarkus.otel.sdk.disabled=true

# Auth configuration for tests
villagecompute.auth.cookie.name=vu_anon_id
villagecompute.auth.cookie.secure=true
villagecompute.auth.cookie.http-only=true
villagecompute.auth.cookie.same-site=Lax
villagecompute.auth.cookie.max-age=31536000
villagecompute.auth.bootstrap.token=test-bootstrap-token
villagecompute.auth.bootstrap.admin-exists=false
villagecompute.auth.jwt.secret=unit-test-signing-secret
villagecompute.auth.jwt.issuer=test-suite
villagecompute.auth.jwt.audience=village-homepage-test
villagecompute.auth.jwt.expiration-minutes=30
villagecompute.auth.rate-limit.bootstrap.max-requests=5
villagecompute.auth.rate-limit.bootstrap.window-seconds=3600
villagecompute.auth.rate-limit.login.max-requests=20
villagecompute.auth.rate-limit.login.window-seconds=60

# Alpha Vantage API (test key)
alphavantage.api-key=test-api-key

# Stripe API keys (test values)
stripe.secret-key=sk_test_dummy_for_tests
stripe.webhook-secret=whsec_test_dummy_for_tests

# Email IMAP configuration (test values)
email.imap.host=localhost
email.imap.port=1143
email.imap.username=test@example.com
email.imap.password=test_placeholder
email.imap.folder=INBOX
email.imap.poll-interval-seconds=60

# Quarkus Mailer SMTP Configuration for tests (GreenMail)
quarkus.mailer.host=localhost
quarkus.mailer.port=3025
quarkus.mailer.from=test@villagecompute.com
quarkus.mailer.mock=false
quarkus.mailer.tls=false
quarkus.mailer.start-tls=DISABLED

# Email notification settings for tests
email.notifications.from=notifications@villagecompute.com
email.notifications.base-url=http://localhost:8080
email.notifications.platform-name=Village Homepage Test

# LangChain4j configuration for tests
# Specify providers: Anthropic for chat, OpenAI for embeddings
quarkus.langchain4j.chat-model.provider=anthropic
quarkus.langchain4j.embedding-model.provider=openai
# Anthropic chat model config (mocked in tests via @InjectMock)
quarkus.langchain4j.anthropic.api-key=sk-ant-test-dummy-key-00000000000000000000000000000000
quarkus.langchain4j.anthropic.chat-model.model-name=claude-3-5-sonnet-20241022
# OpenAI embedding model config (mocked in tests via @InjectMock)
# Note: Anthropic doesn't provide embedding models; using OpenAI
quarkus.langchain4j.openai.api-key=sk-proj-test-dummy-key-0000000000000000000000000000000000000000000000
quarkus.langchain4j.openai.embedding-model.model-name=text-embedding-3-small

# AI Model Configuration (Feature I4.T6)
ai.model.sonnet.name=claude-3-5-sonnet-20241022
ai.model.haiku.name=claude-3-haiku-20240307
ai.model.temperature=0.7
ai.model.max-tokens=4096
ai.model.timeout-seconds=60
ai.model.max-retries=3
# Explicitly use PostGIS dialect for spatial type support
quarkus.hibernate-orm.dialect=org.hibernate.spatial.dialect.postgis.PostgisPG10Dialect
