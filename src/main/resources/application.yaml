quarkus:
  application:
    name: village-homepage
    version: ${project.version:dev}
  http:
    port: 8080

  # S3 Configuration - Disable DevServices (use MinIO from docker-compose)
  s3:
    devservices:
      enabled: false
    # S3 Client Configuration for Cloudflare R2 (Policy P4)
    aws:
      region: ${S3_REGION:auto}
      credentials:
        type: static
        static-provider:
          access-key-id: ${S3_ACCESS_KEY:minioadmin}
          secret-access-key: ${S3_SECRET_KEY:minioadmin}
    endpoint-override: ${S3_ENDPOINT:http://localhost:9000}

  # Logging Configuration
  log:
    level: INFO
    console:
      # Enable structured JSON logging for production observability
      json: true
      json:
        # Standard fields automatically included: timestamp, sequence, loggerClassName, loggerName, level, message, threadName, threadId
        # Custom fields added via MDC enrichment (see LoggingEnricher)
        additional-field:
          service.name.value: village-homepage
          service.version.value: ${quarkus.application.version}
          environment.value: ${ENVIRONMENT:dev}

    # Minimum log levels by category
    category:
      "villagecompute.homepage": DEBUG
      "io.quarkus": INFO
      "org.hibernate": WARN

  # OpenTelemetry Configuration
  otel:
    # Service identification
    resource:
      attributes: "service.name=village-homepage,service.version=${quarkus.application.version},deployment.environment=${ENVIRONMENT:dev}"

    # Tracing configuration
    traces:
      sampler: always_on

    # OTLP exporter settings
    exporter:
      otlp:
        # Dev profile uses local Jaeger (from docker-compose)
        endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4318}
        protocol: http/protobuf
        timeout: 10s
        # Compress traces for network efficiency
        compression: gzip

    # Propagation format for distributed tracing
    propagators: tracecontext,baggage

    # SDK configuration
    sdk:
      disabled: false

  # Hibernate ORM Configuration
  hibernate-orm:
    # JSON format mapping for database columns (JSONB support)
    # Uses global formatting facilities for JSON serialization/deserialization
    mapping:
      format:
        # Ignore format mapper warnings - we use standard ObjectMapper for database JSON
        global: ignore

  # OIDC Multi-Tenant Configuration (Policy P1, P9, F1)
  # Supports Google, Facebook, and Apple OAuth providers
  oidc:
    tenant-enabled: true
    authentication:
      # Callback endpoint consumed by AuthIdentityService bootstrap flow
      redirect-path: /api/auth/callback
    google:
      auth-server-url: https://accounts.google.com
      client-id: ${GOOGLE_CLIENT_ID:}
      credentials:
        secret: ${GOOGLE_CLIENT_SECRET:}
      application-type: web-app
      authentication:
        scopes: openid,email,profile
      token:
        refresh-expired: true
        refresh-token-time-skew: 5s
      token-state-manager:
        encryption-secret: ${OIDC_STATE_SECRET:local-dev-oidc-state-secret}

    facebook:
      auth-server-url: https://www.facebook.com
      client-id: ${FACEBOOK_APP_ID:}
      credentials:
        secret: ${FACEBOOK_APP_SECRET:}
      application-type: web-app
      authentication:
        scopes: email,public_profile
      token:
        refresh-expired: true
        refresh-token-time-skew: 5s
      token-state-manager:
        encryption-secret: ${OIDC_STATE_SECRET:local-dev-oidc-state-secret}

    apple:
      auth-server-url: https://appleid.apple.com
      client-id: ${APPLE_CLIENT_ID:}
      credentials:
        secret: ${APPLE_CLIENT_SECRET:}
      application-type: web-app
      authentication:
        scopes: email,name
      token:
        refresh-expired: true
        refresh-token-time-skew: 5s
      token-state-manager:
        encryption-secret: ${OIDC_STATE_SECRET:local-dev-oidc-state-secret}

# VillageCompute Authentication Configuration (Policy P1, P9)
villagecompute:
  auth:
    # Anonymous cookie settings (Policy P9)
    cookie:
      name: vu_anon_id
      max-age: 31536000  # 1 year in seconds
      secure: ${COOKIE_SECURE:true}
      http-only: true
      same-site: Lax
      # Domain for production subdomain sharing (optional, defaults to current host)
      domain: ${COOKIE_DOMAIN:}

    # Bootstrap superuser token (Policy P1)
    # One-time use token for first admin creation
    # Stored in Kubernetes secret: homepage-bootstrap-credentials
    bootstrap:
      token: ${BOOTSTRAP_TOKEN:}
      admin-exists: ${BOOTSTRAP_ADMIN_EXISTS:false}

    # JWT session signing (Policy P9)
    jwt:
      issuer: ${JWT_ISSUER:https://homepage.villagecompute.com}
      audience: village-homepage
      secret: ${JWT_SESSION_SECRET:local-dev-secret-change-me}
      expiration-minutes: ${JWT_EXPIRATION_MINUTES:60}

    rate-limit:
      login:
        max-requests: ${AUTH_LOGIN_MAX_REQUESTS:20}
        window-seconds: ${AUTH_LOGIN_WINDOW_SECONDS:60}
      bootstrap:
        max-requests: ${BOOTSTRAP_MAX_REQUESTS:5}
        window-seconds: ${BOOTSTRAP_WINDOW_SECONDS:3600}

  # Stripe Payment Integration (Policy P3, Feature F12.8)
  stripe:
    secret-key: ${STRIPE_SECRET_KEY:sk_test_CHANGE_ME}
    webhook-secret: ${STRIPE_WEBHOOK_SECRET:whsec_CHANGE_ME}
    publishable-key: ${STRIPE_PUBLISHABLE_KEY:pk_test_CHANGE_ME}

  # LangChain4j AI Integration (Policy P2/P10)
  langchain4j:
    anthropic:
      api-key: ${ANTHROPIC_API_KEY:}
      chat-model:
        model-name: claude-sonnet-4-20250514
        temperature: 0.3
        max-tokens: 2000
        timeout: 30s
      log-requests: ${AI_LOG_REQUESTS:false}
      log-responses: ${AI_LOG_RESPONSES:false}

  # Object Storage Configuration (Policy P4: Indefinite retention with versioning)
  storage:
    # S3/R2 Connection Settings
    endpoint: ${S3_ENDPOINT:http://localhost:9000}  # MinIO for dev, R2 for prod
    access-key: ${S3_ACCESS_KEY:minioadmin}
    secret-key: ${S3_SECRET_KEY:minioadmin}
    region: ${S3_REGION:auto}  # Cloudflare R2 uses 'auto'

    # Bucket names per asset domain (Policy P4)
    buckets:
      screenshots: ${S3_BUCKET_SCREENSHOTS:screenshots}
      listings: ${S3_BUCKET_LISTINGS:listings}
      profiles: ${S3_BUCKET_PROFILES:profiles}

    # Signed URL TTLs (Policy P4)
    signed-url-ttl:
      private-minutes: ${SIGNED_URL_PRIVATE_TTL:1440}  # 24 hours for drafts
      public-minutes: ${SIGNED_URL_PUBLIC_TTL:10080}    # 7 days for public assets

    # WebP conversion settings (Policy P4: thumbnail/full variants)
    webp:
      quality: ${WEBP_QUALITY:85}
      thumbnail-width: 320
      thumbnail-height: 200
      full-width: 1280
      full-height: 800

# Profile-specific overrides
"%dev":
  quarkus:
    log:
      console:
        # Use human-readable logs in dev mode (override JSON)
        json: false
        format: "%d{HH:mm:ss} %-5p [%c{2.}] (%t) %X{trace_id} %X{user_id} %s%e%n"
    otel:
      exporter:
        otlp:
          # Local Jaeger from docker-compose
          endpoint: http://localhost:4318
    # OIDC dev overrides - disable secure cookies for HTTP
  # Development cookie settings (HTTP-compatible)
  villagecompute:
    auth:
      cookie:
        secure: false

"%test":
  quarkus:
    log:
      level: WARN
      console:
        json: false
    otel:
      sdk:
        # Disable telemetry in tests to avoid noise
        disabled: true
    datasource:
      db-kind: h2
      username: sa
      password: sa
      jdbc:
        url: jdbc:h2:mem:homepage-tests;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE;DB_CLOSE_DELAY=-1
        driver: org.h2.Driver
      devservices:
        enabled: false
    # Disable S3 dev services in tests
    s3:
      devservices:
        enabled: false
    # Tests use in-memory H2 to avoid external Postgres dependency
    hibernate-orm:
      database:
        # Create/drop schema for test isolation
        generation: drop-and-create
      # Suppress unnecessary warnings in tests
      log:
        sql: false

"%prod":
  quarkus:
    log:
      console:
        json: true
      category:
        "villagecompute.homepage": INFO
    otel:
      exporter:
        otlp:
          # Production collector endpoint (managed by ops team)
          # Set via environment variable: OTEL_EXPORTER_OTLP_ENDPOINT
          endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT}
          headers: ${OTEL_EXPORTER_OTLP_HEADERS:}
