quarkus:
  application:
    name: village-homepage
    version: ${project.version:dev}
  http:
    port: 8080

  # Qute Configuration
  qute:
    strict-rendering: false
    property-not-found-strategy: default
    type-check-excludes: "ProfileResource/**"

  # REST Client Configuration
  rest-client:
    # Google OAuth REST client (Policy P1, Feature F1)
    google-oauth:
      url: https://oauth2.googleapis.com
      scope: jakarta.inject.Singleton
      # Connection timeout for OAuth API calls
      connect-timeout: 10000
      read-timeout: 10000

    # Facebook OAuth REST client (Policy P1, Feature F1)
    facebook-oauth:
      url: https://graph.facebook.com/v18.0
      scope: jakarta.inject.Singleton
      # Connection timeout for OAuth API calls
      connect-timeout: 10000
      read-timeout: 10000

    # Apple OAuth REST client (Policy P1, Feature F1)
    apple-oauth:
      url: https://appleid.apple.com
      scope: jakarta.inject.Singleton
      # Connection timeout for OAuth API calls
      connect-timeout: 10000
      read-timeout: 10000

  # S3 Configuration - Disable DevServices (use MinIO from docker-compose)
  s3:
    devservices:
      enabled: false
    # S3 Client Configuration for Cloudflare R2 (Policy P4)
    aws:
      region: ${S3_REGION:auto}
      credentials:
        type: static
        static-provider:
          access-key-id: ${S3_ACCESS_KEY:minioadmin}
          secret-access-key: ${S3_SECRET_KEY:minioadmin}
    endpoint-override: ${S3_ENDPOINT:http://localhost:9000}

  # Logging Configuration
  log:
    level: INFO
    console:
      # Enable structured JSON logging for production observability
      json: true
      json:
        # Standard fields automatically included: timestamp, sequence, loggerClassName, loggerName, level, message, threadName, threadId
        # Custom fields added via MDC enrichment (see LoggingEnricher)
        additional-field:
          service.name.value: village-homepage
          service.version.value: ${quarkus.application.version}
          environment.value: ${ENVIRONMENT:dev}

    # Minimum log levels by category
    category:
      "villagecompute.homepage": DEBUG
      "io.quarkus": INFO
      "org.hibernate": WARN

  # OpenTelemetry Configuration
  otel:
    # Service identification
    resource:
      attributes: "service.name=village-homepage,service.version=${quarkus.application.version},deployment.environment=${ENVIRONMENT:dev}"

    # Tracing configuration
    traces:
      sampler: always_on

    # OTLP exporter settings
    exporter:
      otlp:
        # Dev profile uses local Jaeger (from docker-compose)
        endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4318}
        protocol: http/protobuf
        timeout: 10s
        # Compress traces for network efficiency
        compression: gzip

    # Propagation format for distributed tracing
    propagators: tracecontext,baggage

    # SDK configuration
    sdk:
      disabled: false

  # Hibernate ORM Configuration
  hibernate-orm:
    # Database schema management (Policy I2: Named query validation)
    database:
      generation: none
    sql-load-script: no-file

    # JSON format mapping for database columns (JSONB support)
    # Uses global formatting facilities for JSON serialization/deserialization
    mapping:
      format:
        # Ignore format mapper warnings - we use standard ObjectMapper for database JSON
        global: ignore

  # Hibernate Search + Elasticsearch Configuration (Policy P11, Feature F12.2)
  hibernate-search-orm:
    elasticsearch:
      # Dev: localhost, Prod: ES cluster endpoint
      hosts: ${ELASTICSEARCH_HOSTS:localhost:9200}
      protocol: http
      # Automatic indexing: sync updates to ES on entity persist/update
      automatic-indexing:
        enabled: true
        synchronization-strategy: sync
      # Schema management: create-or-update for migrations, validate in prod
      schema-management:
        strategy: ${ELASTICSEARCH_SCHEMA_STRATEGY:create-or-update}
      # Indexing queue configuration for async operations
      indexing:
        queue-count: 4
        queue-size: 50
      # Request timeout for ES operations
      request-timeout: 10s

  # OIDC Multi-Tenant Configuration (Policy P1, P9, F1)
  # Supports Google, Facebook, and Apple OAuth providers
  oidc:
    tenant-enabled: true
    authentication:
      # Callback endpoint consumed by AuthIdentityService bootstrap flow
      redirect-path: /api/auth/callback
    google:
      auth-server-url: https://accounts.google.com
      client-id: ${GOOGLE_CLIENT_ID:}
      credentials:
        secret: ${GOOGLE_CLIENT_SECRET:}
      application-type: web-app
      authentication:
        scopes: openid,email,profile
      token:
        refresh-expired: true
        refresh-token-time-skew: 5s
      token-state-manager:
        encryption-secret: ${OIDC_STATE_SECRET:local-dev-oidc-state-secret}

    facebook:
      auth-server-url: https://www.facebook.com
      client-id: ${FACEBOOK_APP_ID:}
      credentials:
        secret: ${FACEBOOK_APP_SECRET:}
      application-type: web-app
      authentication:
        scopes: email,public_profile
      token:
        refresh-expired: true
        refresh-token-time-skew: 5s
      token-state-manager:
        encryption-secret: ${OIDC_STATE_SECRET:local-dev-oidc-state-secret}

    apple:
      auth-server-url: https://appleid.apple.com
      client-id: ${APPLE_CLIENT_ID:}
      credentials:
        secret: ${APPLE_CLIENT_SECRET:}
      application-type: web-app
      authentication:
        scopes: email,name
      token:
        refresh-expired: true
        refresh-token-time-skew: 5s
      token-state-manager:
        encryption-secret: ${OIDC_STATE_SECRET:local-dev-oidc-state-secret}

  # LangChain4j AI Integration (Policy P2/P10)
  langchain4j:
    anthropic:
      api-key: ${ANTHROPIC_API_KEY:}
      chat-model:
        model-name: claude-3-5-sonnet-20241022  # Claude Sonnet 3.5 for production accuracy
        temperature: 0.7  # Balanced creativity for content tagging
        max-tokens: 4096  # Support longer responses for categorization
        timeout: 60s  # Prevent hanging requests
        max-retries: 3  # Handle transient failures (429 rate limits, 5xx errors)
      log-requests: ${AI_LOG_REQUESTS:false}
      log-responses: ${AI_LOG_RESPONSES:false}

# VillageCompute Authentication Configuration (Policy P1, P9)
villagecompute:
  auth:
    # Anonymous cookie settings (Policy P9)
    cookie:
      name: vu_anon_id
      max-age: 31536000  # 1 year in seconds
      secure: ${COOKIE_SECURE:true}
      http-only: true
      same-site: Lax
      # Domain for production subdomain sharing (optional, defaults to current host)
      domain: ${COOKIE_DOMAIN:}

    # Session cookie settings (authenticated users)
    session:
      cookie:
        name: vu_session
        max-age: 86400  # 24 hours in seconds
        # Inherits secure, http-only, same-site, and domain from anonymous cookie settings

    # Bootstrap superuser token (Policy P1)
    # One-time use token for first admin creation
    # Stored in Kubernetes secret: homepage-bootstrap-credentials
    bootstrap:
      token: ${BOOTSTRAP_TOKEN:}
      admin-exists: ${BOOTSTRAP_ADMIN_EXISTS:false}

    # JWT session signing (Policy P9)
    jwt:
      issuer: ${JWT_ISSUER:https://homepage.villagecompute.com}
      audience: village-homepage
      secret: ${JWT_SESSION_SECRET:local-dev-secret-change-me}
      expiration-minutes: ${JWT_EXPIRATION_MINUTES:60}

    rate-limit:
      login:
        max-requests: ${AUTH_LOGIN_MAX_REQUESTS:20}
        window-seconds: ${AUTH_LOGIN_WINDOW_SECONDS:60}
      bootstrap:
        max-requests: ${BOOTSTRAP_MAX_REQUESTS:5}
        window-seconds: ${BOOTSTRAP_WINDOW_SECONDS:3600}

  # Apple Sign-In JWT Configuration (Feature I3.T3)
  apple:
    team-id: ${APPLE_TEAM_ID:}
    key-id: ${APPLE_KEY_ID:}
    private-key-path: ${APPLE_PRIVATE_KEY_PATH:/secrets/apple-auth-key.p8}

  # Stripe Payment Integration (Policy P3, Feature F12.8)
  stripe:
    secret-key: ${STRIPE_SECRET_KEY:sk_test_CHANGE_ME}
    webhook-secret: ${STRIPE_WEBHOOK_SECRET:whsec_CHANGE_ME}
    publishable-key: ${STRIPE_PUBLISHABLE_KEY:pk_test_CHANGE_ME}

  # Object Storage Configuration (Policy P4: Indefinite retention with versioning)
  storage:
    # S3/R2 Connection Settings
    endpoint: ${S3_ENDPOINT:http://localhost:9000}  # MinIO for dev, R2 for prod
    access-key: ${S3_ACCESS_KEY:minioadmin}
    secret-key: ${S3_SECRET_KEY:minioadmin}
    region: ${S3_REGION:auto}  # Cloudflare R2 uses 'auto'

    # Bucket names per asset domain (Policy P4)
    buckets:
      screenshots: ${S3_BUCKET_SCREENSHOTS:screenshots}
      listings: ${S3_BUCKET_LISTINGS:listings}
      profiles: ${S3_BUCKET_PROFILES:profiles}
      gdpr-exports: ${S3_BUCKET_GDPR_EXPORTS:gdpr-exports}

    # Signed URL TTLs (Policy P4)
    signed-url-ttl:
      private-minutes: ${SIGNED_URL_PRIVATE_TTL:1440}  # 24 hours for drafts
      public-minutes: ${SIGNED_URL_PUBLIC_TTL:10080}    # 7 days for public assets

    # WebP conversion settings (Policy P4: thumbnail/full variants)
    webp:
      quality: ${WEBP_QUALITY:85}
      thumbnail-width: 320
      thumbnail-height: 200
      full-width: 1280
      full-height: 800

# Email Configuration (Features F12.6, F14.3: Marketplace email relay)
email:
  imap:
    # IMAP server for polling inbound replies (F14.3)
    # Dev: Mailpit (localhost:1143), Prod: Gmail/AWS SES/etc
    host: ${EMAIL_IMAP_HOST:localhost}
    port: ${EMAIL_IMAP_PORT:1143}
    username: ${EMAIL_IMAP_USERNAME:}
    password: ${EMAIL_IMAP_PASSWORD:}
    folder: ${EMAIL_IMAP_FOLDER:INBOX}
    ssl: ${EMAIL_IMAP_SSL:false}
    # In dev mode with Mailpit: host=localhost, port=1143, username=empty, password=empty, ssl=false
    # In prod with Gmail: host=imap.gmail.com, port=993, username=email@domain.com, password=${EMAIL_IMAP_PASSWORD}, ssl=true

  # Notification settings (Policy F14.3: Email Communication)
  notifications:
    from: ${EMAIL_FROM:noreply@villagecompute.com}
    platform-name: ${EMAIL_PLATFORM_NAME:Village Homepage}
    base-url: ${EMAIL_BASE_URL:https://homepage.villagecompute.com}
    ops-alert-email: ${EMAIL_OPS_ALERT:ops@villagecompute.com}

# GDPR Configuration (Policy P1: GDPR/CCPA data governance)
gdpr:
  # Data export settings
  export-ttl-days: ${GDPR_EXPORT_TTL_DAYS:7}  # Signed URL validity period

  # Deletion settings
  deletion-delay-hours: ${GDPR_DELETION_DELAY_HOURS:0}  # Immediate deletion by default

# Profile-specific overrides
"%dev":
  quarkus:
    log:
      console:
        # Use human-readable logs in dev mode (override JSON)
        json: false
        format: "%d{HH:mm:ss} %-5p [%c{2.}] (%t) %X{trace_id} %X{user_id} %s%e%n"
    otel:
      exporter:
        otlp:
          # Local Jaeger from docker-compose
          endpoint: http://localhost:4318
  # Development cookie settings (HTTP-compatible)
  villagecompute:
    auth:
      cookie:
        secure: false

"%test":
  quarkus:
    log:
      level: WARN
      console:
        json: false
    otel:
      sdk:
        # Disable telemetry in tests to avoid noise
        disabled: true
    # NOTE: Datasource configuration moved to application-test.properties
    # Tests using @TestProfile(PostgreSQLTestProfile.class) use PostgreSQL Testcontainers
    # Legacy tests using @QuarkusTestResource(H2TestResource.class) use H2 in-memory
    # Disable S3 dev services in tests
    s3:
      devservices:
        enabled: false
    # Disable Elasticsearch in tests (use in-memory indexing)
    hibernate-search-orm:
      elasticsearch:
        schema-management:
          strategy: drop-and-create
      backend:
        type: lucene

"%prod":
  quarkus:
    log:
      console:
        json: true
      category:
        "villagecompute.homepage": INFO
    otel:
      exporter:
        otlp:
          # Production collector endpoint (managed by ops team)
          # Set via environment variable: OTEL_EXPORTER_OTLP_ENDPOINT
          endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT}
          headers: ${OTEL_EXPORTER_OTLP_HEADERS:}
